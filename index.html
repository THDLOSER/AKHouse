<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>想你牆（萬花筒・彩色玻璃＋設定版）</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111111; --sub:#555; --card:#ffffff; --br:#e6e6e6;
    --btn:#fafafa; --btn-br:#dddddd;
    --c-think:#ff6aa2; --c-hug:#6aa8ff; --c-kiss:#7bd88f; --c-lean:#f7c84b; --c-rub:#c18cff; --c-tap:#ff9b6a;
  }
  [data-theme="dark"]{
    --bg:#0f1115; --fg:#ffffff; --sub:#c7c7c7; --card:#141820; --br:#2a2f3a;
    --btn:#1a1f29; --btn-br:#2a2f3a;
    --c-think:#ff84b4; --c-hug:#8bbbff; --c-kiss:#9be3ab; --c-lean:#ffd76a; --c-rub:#d2a6ff; --c-tap:#ffb489;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--br)}
  header .right{display:flex;gap:8px;align-items:center}
  .wrap{padding:14px 14px 28px;display:flex;flex-direction:column;gap:12px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:720px;margin:0 auto;width:100%}
  @media(min-width:640px){.grid{grid-template-columns:repeat(3,1fr)}}
  button{
    padding:14px 12px;border:1px solid var(--btn-br);border-radius:10px;background:var(--btn);cursor:pointer;
    font-size:16px;font-weight:700;color:var(--fg)
  }
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.row{grid-template-columns:1.2fr .8fr}}
  .canvas-wrap{border:1px dashed var(--br);border-radius:12px;padding:10px;background:var(--card)}
  #wall{width:100%;height:52vh;display:block}
  .kaleido-hud{margin-bottom:8px;font-size:14px;line-height:1.6;color:var(--fg)}
  .legend{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0 0}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--br);border-radius:999px;padding:6px 10px;background:var(--card);color:var(--fg)}
  .dot{width:10px;height:10px;border-radius:50%}
  .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:12px}
  .muted{color:var(--sub)}
  table{width:100%;border-collapse:collapse;color:var(--fg)}
  th,td{border-bottom:1px solid var(--br);padding:8px 6px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .kpi{display:flex;gap:12px;flex-wrap:wrap}
  .kpi .box{background:var(--card);border:1px solid var(--br);border-radius:10px;padding:10px 12px;min-width:120px}
  .ghost{opacity:.7}
  input,textarea,select{background:var(--card);color:var(--fg);border:1px solid var(--br);border-radius:10px;padding:10px}
  textarea{width:100%;box-sizing:border-box;resize:vertical}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:12px;margin-right:6px;border:1px solid var(--br);background:var(--card);color:var(--fg)}
  .badge.think{border-color:var(--c-think)}
  .badge.hug{border-color:var(--c-hug)}
  .badge.kiss{border-color:var(--c-kiss)}
  .badge.lean{border-color:var(--c-lean)}
  .badge.rub{border-color:var(--c-rub)}
  .badge.tap{border-color:var(--c-tap)}
  .reply{margin-left:12px;padding-left:10px;border-left:2px solid var(--br)}
</style>
</head>
<body>

<!-- 全域保險絲 -->
<script>
  window.lastCounts = {think:0,hug:0,kiss:0,lean:0,rub:0,tap:0};
  window.drawAll = window.drawAll || function(){};
  window.fitCanvas = window.fitCanvas || function(){};
</script>

<header>
  <div><strong>想你牆</strong> <span class="muted">（A&K House）</span></div>
  <div class="right">
    <button id="btnTheme" title="切換主題">🌙/☀️</button>
    <button id="btnToggleView" title="切換萬花筒/正字牆">🌸 萬花筒</button>
    <button id="btnKaleidoCfg" title="萬花筒設定">🎛️ 設定</button>
    <button id="btnResetGate" title="重新驗證">🔒 重新驗證</button>
  </div>
</header>

<div class="wrap">

  <!-- 問答解鎖 -->
  <div id="gate" class="card">
    <div style="font-weight:800;margin-bottom:6px">我們約定好幾歲？</div>
    <div class="toolbar">
      <input id="inpAge" type="text" inputmode="numeric" placeholder="請輸入數字" />
      <button id="btnGate">解鎖</button>
    </div>
    <div id="gateMsg" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- 主功能 -->
  <div id="main" style="display:none">
    <div class="grid" style="margin-bottom:6px">
      <button class="action-btn" data-key="think">🩷 想你</button>
      <button class="action-btn" data-key="hug">🤗 想抱抱</button>
      <button class="action-btn" data-key="kiss">😘 親親</button>
      <button class="action-btn" data-key="lean">🫴 靠一下</button>
      <button class="action-btn" data-key="rub">🐾 搓搓</button>
      <button class="action-btn" data-key="tap">👊 打打（扣）</button>
    </div>

    <div class="row">
      <div class="canvas-wrap">
        <div id="kaleidoHud" class="kaleido-hud" style="display:none"></div>
        <canvas id="wall"></canvas>
        <div class="legend">
          <span class="chip"><span class="dot" style="background:var(--c-think)"></span>想你</span>
          <span class="chip"><span class="dot" style="background:var(--c-hug)"></span>抱抱</span>
          <span class="chip"><span class="dot" style="background:var(--c-kiss)"></span>親親</span>
          <span class="chip"><span class="dot" style="background:var(--c-lean)"></span>靠一下</span>
          <span class="chip"><span class="dot" style="background:var(--c-rub)"></span>搓搓</span>
          <span class="chip"><span class="dot" style="background:var(--c-tap)"></span>打打（扣）</span>
          <span class="muted" style="margin-left:6px">＊每 100 以 💯、每 50 以 ✨ 表示</span>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px">倒數</div>
        <div class="kpi">
          <div class="box">
            <div class="muted">距上次兌現已過</div>
            <div id="sinceTxt" style="font-size:18px;font-weight:800">--</div>
          </div>
          <div class="box">
            <div class="muted">目前累計已兌現（全部期間）</div>
            <div id="sumAllTxt" style="font-size:14px">
              想你 <b id="sumThink">0</b>、抱抱 <b id="sumHug">0</b>、親親 <b id="sumKiss">0</b>、靠一下 <b id="sumLean">0</b>、搓搓 <b id="sumRub">0</b>、打打(扣) <b id="sumTap">0</b>
            </div>
          </div>
        </div>

        <div class="toolbar" style="margin-top:10px">
          <button id="btnRedeemOpen">🎁 全部兌現</button>
          <button id="btnPostNoteOpen">📝 只是單獨留言</button>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">兌現統計表（可篩選）</div>
          <div class="toolbar" style="margin-bottom:6px">
            <label>年 <select id="selYear"></select></label>
            <label>月 <select id="selMonth"><option value="">全部</option></select></label>
            <button id="btnExportCsv">⬇️ 匯出CSV</button>
            <button id="btnExportZip">📦 打包匯出ZIP</button>
            <span class="muted">本期間合計：想你 <b id="sumPThink">0</b>、抱抱 <b id="sumPHug">0</b>、親親 <b id="sumPKiss">0</b>、靠一下 <b id="sumPLean">0</b>、搓搓 <b id="sumPRub">0</b>、打打(扣) <b id="sumPTap">0</b></span>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>日期</th><th>想你</th><th>抱抱</th><th>親親</th><th>靠一下</th><th>搓搓</th><th>打打(扣)</th><th>扣到</th></tr></thead>
              <tbody id="tbStats"><tr><td colspan="8" class="muted">讀取中…</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">近期兌現小故事</div>
          <div class="toolbar" style="margin-bottom:6px">
            <label>排序
              <select id="selStorySort">
                <option value="ts_desc">時間：新 → 舊</option>
                <option value="ts_asc">時間：舊 → 新</option>
                <option value="total_desc">合計：多 → 少</option>
                <option value="rub_desc">搓搓：多 → 少</option>
              </select>
            </label>
            <button id="btnColorCfg" class="ghost">🎨 顏色設定</button>
          </div>
          <div id="storiesList" class="muted">尚無紀錄</div>
          <div style="margin-top:8px"><button id="btnMoreStories" class="ghost">載入更多小故事</button></div>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">只是單獨留言（含回覆，不影響計數）</div>
          <div class="toolbar" style="margin-bottom:6px">
            <button id="btnExportNotesCsv">⬇️ 匯出留言CSV</button>
            <span class="muted">（依上方年／月篩選）</span>
          </div>
          <div id="notesList" class="muted">尚無留言</div>
          <div style="margin-top:8px"><button id="btnMoreNotes" class="ghost">載入更多留言</button></div>
        </div>

      </div>
    </div>
  </div>
</div>

<audio id="meowSound" src="meow.mp3" preload="auto"></audio>

<script>
  /* ====== 公用錯誤面板 ====== */
  function showErrorOverlay(err){
    try{
      const box = document.createElement('div');
      box.style.position='fixed'; box.style.left='10px'; box.style.right='10px';
      box.style.bottom='10px'; box.style.zIndex='9999';
      box.style.padding='10px 12px'; box.style.border='1px solid var(--br)';
      box.style.borderRadius='10px'; box.style.background='var(--card)';
      box.style.color='var(--fg)'; box.style.fontSize='12px';
      box.style.maxHeight='40vh'; box.style.overflow='auto';
      box.innerHTML = `<b>載入時發生錯誤</b><br><pre style="white-space:pre-wrap">${(err && (err.stack||err.message||String(err)))}</pre>`;
      document.body.appendChild(box);
    }catch{}
  }
  window.addEventListener('error', e => showErrorOverlay(e.error || e.message));
  window.addEventListener('unhandledrejection', e => showErrorOverlay(e.reason || e));

  /* ====== 主題切換 ====== */
  (function(){
    const root = document.documentElement;
    const btnTheme = document.getElementById('btnTheme');
    function applyTheme(v){
      root.setAttribute('data-theme', v==='dark' ? 'dark' : 'light');
      localStorage.setItem('theme', v);
      if (typeof window.fitCanvas === 'function') window.fitCanvas();
    }
    const saved = localStorage.getItem('theme');
    if (saved) applyTheme(saved);
    else applyTheme( window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' );
    btnTheme?.addEventListener('click', ()=> {
      const next = root.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
      applyTheme(next);
    });
  })();

  /* ====== 問答解鎖（65） ====== */
  (function(){
    const GATE_ANSWER = 65, GATE_TTL_DAYS = 7;
    const gate = document.getElementById('gate'), main = document.getElementById('main');
    const inpAge = document.getElementById('inpAge'), btnGate = document.getElementById('btnGate');
    const gateMsg = document.getElementById('gateMsg'), btnResetGate = document.getElementById('btnResetGate');
    function toHalfWidthNum(s){ return (s||'').replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0)-0xFEE0)); }
    function normAge(v){ const s = toHalfWidthNum(String(v||'')).replace(/\s+/g,'').replace(/[^\d]/g,''); const n = parseInt(s,10); return Number.isFinite(n)?n:NaN; }
    function openGate(){ gate.style.display='block'; main.style.display='none'; }
    function openMain(){ gate.style.display='none'; main.style.display='block'; }
    function gateOk(){ const ok = localStorage.getItem('gate-ok')==='1'; if(!ok) return false; if(GATE_TTL_DAYS<=0) return false; const ts=parseInt(localStorage.getItem('gate-ok-ts')||'0',10); return (Date.now()-ts)<GATE_TTL_DAYS*86400000; }
    function setGateOk(){ localStorage.setItem('gate-ok','1'); localStorage.setItem('gate-ok-ts', String(Date.now())); }
    btnResetGate.onclick = ()=>{ localStorage.removeItem('gate-ok'); localStorage.removeItem('gate-ok-ts'); openGate(); };

    if (new URLSearchParams(location.search).get('reset')==='1'){
      localStorage.removeItem('gate-ok'); localStorage.removeItem('gate-ok-ts');
    }
    if (gateOk()){ openMain(); localStorage.setItem('app-should-init','1'); } else { openGate(); }

    btnGate.onclick = ()=>{
      const n=normAge(inpAge.value);
      if(n===GATE_ANSWER){
        setGateOk(); gateMsg.textContent=''; openMain();
        localStorage.setItem('app-should-init','1');
        if (typeof window.__afterUnlock === 'function') window.__afterUnlock();
      }else{
        gateMsg.textContent='答錯囉～再試試（提示：65）';
      }
    };
    inpAge.addEventListener('keydown', e=>{ if(e.key==='Enter') btnGate.click(); });
  })();
</script>

<!-- ========= 視圖模式（正字牆 / 萬花筒） & 切換 ========= -->
<script>
  let viewMode = localStorage.getItem('viewMode') || 'tally';
  const btnToggleView = document.getElementById('btnToggleView');
  const kaleidoHud = document.getElementById('kaleidoHud');

  function applyView(mode){
    viewMode = mode;
    localStorage.setItem('viewMode', mode);
    if (btnToggleView) {
      btnToggleView.textContent = (mode === 'kaleido') ? '🧱 正字牆' : '🌸 萬花筒';
      btnToggleView.title = '切換萬花筒/正字牆';
    }
    if (kaleidoHud) kaleidoHud.style.display = (mode === 'kaleido') ? 'block' : 'none';
    // 讓內部 drawAll 負責啟動/停止動畫
    if (typeof window.drawAll === 'function') window.drawAll(window.lastCounts || {});
  }

  btnToggleView?.addEventListener('click', ()=>{
    applyView(viewMode === 'kaleido' ? 'tally' : 'kaleido');
  });

  // 初始套用
  applyView(viewMode);
</script>

<!-- ========= 主 App ========= -->
<script>
  window.__afterUnlock = async function(){
    try{
	const firebaseConfig = {
	  apiKey: "AIzaSyAiJTyJGBZIOQW9KAmBUNbxdBFJFr2ABuc",
	  authDomain: "aether-karen-board.firebaseapp.com",
	  projectId: "aether-karen-board",
	  storageBucket: "aether-karen-board.firebasestorage.app",
	  messagingSenderId: "907550532349",
	  appId: "1:907550532349:web:c6bf67c8b86d44e3841494",
	  measurementId: "G-Y91SWR8FBQ"
	};

      const [{ initializeApp }, { getAuth, signInAnonymously }, 
             { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment,
               serverTimestamp, collection, addDoc, getDocs, query, orderBy, limit, startAfter, where }] =
        await Promise.all([
          import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js'),
          import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js')
        ]);

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      try { await signInAnonymously(auth); } 
      catch(e){ showErrorOverlay('匿名登入失敗：請在 Authentication 啟用 Anonymous\n'+(e && (e.message||e))); }

      /* ==== CSS 變數工具 ==== */
      function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
      function setCssVar(k,v){ document.documentElement.style.setProperty(k, v); }
      function tinyHex(s){ const x=(s||'').trim(); if(/^#[0-9a-fA-F]{6}$/.test(x)) return x; if(/^#[0-9a-fA-F]{3}$/.test(x)) return '#'+x[1]+x[1]+x[2]+x[2]+x[3]+x[3]; return '#000000'; }
      function readColors(){ return {
        think: cssVar('--c-think')||'#ff6aa2', hug: cssVar('--c-hug')||'#6aa8ff',
        kiss: cssVar('--c-kiss')||'#7bd88f',  lean: cssVar('--c-lean')||'#f7c84b', rub: cssVar('--c-rub')||'#c18cff', tap: cssVar('--c-tap')||'#ff9b6a'
      }; }
      let COLORS = readColors();

      /* ==== Canvas/繪圖環境 ==== */
      const canvas = document.getElementById('wall');
      const ctx = canvas.getContext('2d', { alpha:true });
      function fitCanvas(){
        const ratio = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * ratio);
        canvas.height= Math.floor(rect.height * ratio);
        ctx.setTransform(ratio,0,0,ratio,0,0);
        drawAll(lastCounts);
      }
      window.fitCanvas = fitCanvas;

      /* ==== 色彩工具 / 漸層 ==== */
      function hexToRgb(hex){
        const h=(hex||'').trim().replace('#','');
        if (![3,6].includes(h.length)) return {r:0,g:0,b:0};
        const f = h.length===3 ? (i)=>parseInt(h[i]+h[i],16) : (i)=>parseInt(h.slice(i*2,i*2+2),16);
        return { r:f(0), g:f(1), b:f(2) };
      }
      function rgbToHsl(r,g,b){
        r/=255; g/=255; b/=255;
        const max=Math.max(r,g,b), min=Math.min(r,g,b);
        let h,s,l=(max+min)/2;
        if (max===min){ h=s=0; }
        else{
          const d=max-min;
          s=l>0.5 ? d/(2-max-min) : d/(max+min);
          switch(max){
            case r: h=(g-b)/d + (g<b?6:0); break;
            case g: h=(b-r)/d + 2; break;
            case b: h=(r-g)/d + 4; break;
          }
          h/=6;
        }
        return {h,s,l};
      }
      function hslToRgba(h,s,l,a=1){
        function hue2rgb(p,q,t){ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; }
        let r,g,b;
        if(s===0){ r=g=b=l; }
        else{
          const q=l<0.5 ? l*(1+s) : l+s-l*s;
          const p=2*l-q;
          r=hue2rgb(p,q,h+1/3);
          g=hue2rgb(p,q,h);
          b=hue2rgb(p,q,h-1/3);
        }
        return `rgba(${Math.round(r*255)},${Math.round(g*255)},${Math.round(b*255)},${a})`;
      }
      function lighten(hex, amt=0.15, a=1){
        const {r,g,b}=hexToRgb(hex); const {h,s,l}=rgbToHsl(r,g,b);
        const nl=Math.max(0,Math.min(1,l+amt));
        return hslToRgba(h,s,nl,a);
      }
      function darken(hex, amt=0.15, a=1){
        const {r,g,b}=hexToRgb(hex); const {h,s,l}=rgbToHsl(r,g,b);
        const nl=Math.max(0,Math.min(1,l-amt));
        return hslToRgba(h,s,nl,a);
      }
      function makeRadialGradient(ctx,x,y,r,hex){
        const g=ctx.createRadialGradient(x,y,r*0.15,x,y,r);
        g.addColorStop(0, lighten(hex,0.25,0.95));
        g.addColorStop(1, darken(hex,0.15,0.95));
        return g;
      }
      function withAlpha(hex, a){
        const {r,g,b}=hexToRgb(hex);
        return `rgba(${r},${g},${b},${Math.max(0,Math.min(1,a))})`;
      }
      function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; } }

      /* ==== 💯/✨/正字 ==== */
      function drawTallies(startX, startY, color, count, scale = 1){
        const spacingX = 40 * scale, spacingY = 38 * scale;
        const rect = canvas.getBoundingClientRect();
        const usable = Math.max(0, rect.width - startX - 20);
        const maxPerRow = Math.max(1, Math.floor(usable / spacingX));
        let x = startX, y = startY;

        const fgColor = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()
                        || (document.documentElement.getAttribute('data-theme')==='dark' ? '#ffffff' : '#333333');

        const hundreds = Math.floor((count || 0) / 100);
        let rem100   = (count || 0) % 100;

        if (hundreds > 0){
          const oldFill = ctx.fillStyle, oldFont = ctx.font;
          ctx.fillStyle = fgColor;
          ctx.font = `bold ${24 * scale}px system-ui`;
          for (let i = 0; i < hundreds; i++){
            ctx.fillText('💯', x, y + 24 * scale);
            x += spacingX;
            if ((i + 1) % maxPerRow === 0){ x = startX; y += spacingY; }
          }
          ctx.fillStyle = oldFill; ctx.font = oldFont;
        }

        const fifties = Math.floor(rem100 / 50);
        let rem50 = rem100 % 50;

        if (fifties > 0){
          const oldFill = ctx.fillStyle, oldFont = ctx.font;
          ctx.fillStyle = fgColor;
          ctx.font = `bold ${24 * scale}px system-ui`;
          for (let i = 0; i < fifties; i++){
            ctx.fillText('✨', x, y + 24 * scale);
            x += spacingX;
            if ((i + 1) % maxPerRow === 0){ x = startX; y += spacingY; }
          }
          ctx.fillStyle = oldFill; ctx.font = oldFont;
        }

        const groups = Math.floor(rem50 / 5);
        const remain = rem50 % 5;

        function drawGroup(x, y, color, scale = 1){
          const h = 28 * scale, gap = 6 * scale, top = y, bottom = y + h;
          ctx.strokeStyle = color; ctx.lineWidth = 2;
          for(let i=0;i<4;i++){
            const xi = x + i * gap + 2 * i;
            ctx.beginPath(); ctx.moveTo(xi, top); ctx.lineTo(xi, bottom); ctx.stroke();
          }
          ctx.beginPath(); ctx.moveTo(x - 2, bottom - 2); ctx.lineTo(x + gap * 3 + 6, top + 2); ctx.stroke();
        }

        for (let i = 0; i < groups; i++){
          drawGroup(x, y, color, scale);
          x += spacingX;
          if ((i + 1) % maxPerRow === 0){ x = startX; y += spacingY; }
        }

        if (remain > 0){
          const top = y, bottom = y + 28 * scale, gap = 6 * scale;
          ctx.strokeStyle = color; ctx.lineWidth = 2;
          for (let i = 0; i < remain; i++){
            const xi = x + i * gap + 2 * i;
            ctx.beginPath(); ctx.moveTo(xi, top); ctx.lineTo(xi, bottom); ctx.stroke();
          }
        }
      }

      /* ==== 正字牆布局 & 繪製 ==== */
      function layout(){
        const rect = canvas.getBoundingClientRect();
        const margin=18, colGap=rect.width/3, rowGap=rect.height/2.2;
        return {
          think:{x:margin, y:margin}, 
          hug:{x:colGap+margin/2, y:margin}, 
          kiss:{x:colGap*2+margin/2, y:margin},
          lean:{x:margin, y:rowGap},  
          rub:{x:colGap+margin/2, y:rowGap},
          tap:{x:colGap*2+margin/2, y:rowGap}
        };
      }
      let lastCounts={think:0,hug:0,kiss:0,lean:0,rub:0,tap:0};
      window.lastCounts = lastCounts;

      /* ====== HUD ====== */
      function renderKaleidoHud(c){
        const colors = getComputedStyle(document.documentElement);
        const items = [
          {label:'想你',  color: colors.getPropertyValue('--c-think'), val:c.think||0},
          {label:'抱抱',  color: colors.getPropertyValue('--c-hug'),   val:c.hug||0},
          {label:'親親',  color: colors.getPropertyValue('--c-kiss'),  val:c.kiss||0},
          {label:'靠一下',color: colors.getPropertyValue('--c-lean'),  val:c.lean||0},
          {label:'搓搓',  color: colors.getPropertyValue('--c-rub'),    val:c.rub||0},
          {label:'打打(扣)',color: colors.getPropertyValue('--c-tap'), val:c.tap||0},
        ];
        const el = document.getElementById('kaleidoHud');
        if (!el) return;
        el.innerHTML = items.map(it =>
          `<span class="chip" style="border-color:${it.color}">
             <span class="dot" style="background:${it.color}"></span>${it.label} <b>${it.val}</b>
           </span>`
        ).join('');
      }

      /* ====== 🎛️ 萬花筒設定（可存 localStorage） ====== */
      const DEF_KCFG = { speed: 0.15, breathe: 0.02, maxPerKind: 40, dots: true, symmetry: 6 };
      let KCFG = (()=>{ try{ return {...DEF_KCFG, ...(JSON.parse(localStorage.getItem('kaleidoCfg')||'{}'))}; }catch{ return {...DEF_KCFG}; }})();
      let SYM = KCFG.symmetry;

      // 設定面板
      (function setupKaleidoConfig(){
        const btn = document.getElementById('btnKaleidoCfg');
        if (!btn) return;
        function openCfgDialog(){
          const html = `
            <div style="font-weight:800;margin-bottom:8px">萬花筒設定</div>
            <div class="toolbar" style="flex-direction:column;gap:10px;min-width:260px">
              <label>旋轉速度（rad/s）
                <input id="k_speed" type="range" min="0" max="1" step="0.01" value="${KCFG.speed}">
                <div class="muted"><span id="k_speed_v">${KCFG.speed}</span></div>
              </label>
              <label>呼吸幅度（比例）
                <input id="k_breathe" type="range" min="0" max="0.1" step="0.005" value="${KCFG.breathe}">
                <div class="muted"><span id="k_breathe_v">${KCFG.breathe}</span></div>
              </label>
              <label>單一類別碎片上限
                <input id="k_max" type="number" min="3" max="120" step="1" value="${KCFG.maxPerKind}">
              </label>
              <label>
                <input id="k_dots" type="checkbox" ${KCFG.dots?'checked':''}> 顯示點點紋理
              </label>
              <label>對稱數
                <select id="k_sym">
                  ${[6,12,18,24].map(v=>`<option value="${v}" ${KCFG.symmetry==v?'selected':''}>${v}</option>`).join('')}
                </select>
              </label>
            </div>
            <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
              <button id="k_save">儲存</button>
              <button id="k_cancel">取消</button>
            </div>
          `;
          const dlg = showDialog(html, (d)=>{
            const sp=d.querySelector('#k_speed'), spv=d.querySelector('#k_speed_v');
            const br=d.querySelector('#k_breathe'), brv=d.querySelector('#k_breathe_v');
            sp.oninput = ()=> spv.textContent = sp.value;
            br.oninput = ()=> brv.textContent = br.value;
            d.querySelector('#k_cancel').onclick = ()=> { try{ d.close(); }catch{} d.remove(); };
            d.querySelector('#k_save').onclick = ()=>{
              const next = {
                speed: parseFloat(sp.value||DEF_KCFG.speed),
                breathe: parseFloat(br.value||DEF_KCFG.breathe),
                maxPerKind: Math.max(3, Math.min(120, parseInt(d.querySelector('#k_max').value||DEF_KCFG.maxPerKind, 10))),
                dots: !!d.querySelector('#k_dots').checked,
                symmetry: parseInt(d.querySelector('#k_sym').value||DEF_KCFG.symmetry, 10)
              };
              KCFG = {...KCFG, ...next};
              localStorage.setItem('kaleidoCfg', JSON.stringify(KCFG));
              SYM = KCFG.symmetry;
              _frags = []; // 強制重生碎片
              if (localStorage.getItem('viewMode')==='kaleido' || viewMode==='kaleido'){
                if (typeof window.drawAll==='function') window.drawAll(window.lastCounts||{});
              }
              try{ d.close(); }catch{} d.remove();
            };
          });
        }
        btn.addEventListener('click', openCfgDialog);
      })();

      /* ====== 萬花筒：圖形生成 + 漸層 + 動畫 ====== */
      let _frags = [];   // 預生成碎片
      let _seed = 0;

      function regenFragments(c, R){
        const seed = ((c.think|0)*13 + (c.hug|0)*29 + (c.kiss|0)*31 + (c.lean|0)*37 + (c.rub|0)*41 + (c.tap|0)*43) >>> 0;
        if (seed === _seed && _frags.length) return;
        _seed = seed;
        const rng = mulberry32(seed);
        const items = [
          {key:'think', color: COLORS.think, val:c.think||0},
          {key:'hug',   color: COLORS.hug,   val:c.hug||0},
          {key:'kiss',  color: COLORS.kiss,  val:c.kiss||0},
          {key:'lean',  color: COLORS.lean,  val:c.lean||0},
          {key:'rub',   color: COLORS.rub,   val:c.rub||0},
          {key:'tap',   color: COLORS.tap,   val:c.tap||0}
        ];
        const wedge = (Math.PI*2)/SYM;
        const list = [];
        items.forEach(it=>{
          const n = Math.min(KCFG.maxPerKind, Math.max(3, Math.ceil(it.val/3)));
          for(let i=0;i<n;i++){
            const r1 = R * (0.12 + 0.78 * rng());
            const r2 = Math.min(R, r1 + R*(0.05 + 0.2*rng()));
            const a0 = wedge * rng();
            const a1 = a0 + wedge*(0.14 + 0.72*rng());
            const k  = (rng()<0.33) ? 'arc' : (rng()<0.66 ? 'petal' : (rng()<0.82 ? 'triangle' : (rng()<0.92 ? 'star' : 'wavy')));
            const dots = KCFG.dots && (rng()<0.18);
            const depth = (r1+r2)/2/R;
            const alpha = (it.key==='tap') ? (0.40 + 0.25*depth) : (0.55 + 0.35*depth);
            list.push({r1,r2,a0,a1,kind:k,color:it.color,alpha,dots});
          }
        });
        _frags = list;
      }

      function drawFrag(kind, r1, r2, a0, a1, baseColor, gradient){
        ctx.fillStyle = gradient || withAlpha(baseColor, 0.85);
        ctx.strokeStyle = withAlpha(baseColor, 0.95);
        ctx.lineWidth = Math.max(1, (Math.min(canvas.width,canvas.height)/600));

        if (kind==='arc'){
          ctx.beginPath();
          ctx.arc(0,0,r2,a0,a1);
          ctx.arc(0,0,r1,a1,a0,true);
          ctx.closePath();
          ctx.fill(); ctx.stroke();
        }else if (kind==='triangle'){
          const mid=(a0+a1)/2;
          ctx.beginPath();
          ctx.moveTo(r1*Math.cos(a0), r1*Math.sin(a0));
          ctx.lineTo(r2*Math.cos(mid), r2*Math.sin(mid));
          ctx.lineTo(r1*Math.cos(a1), r1*Math.sin(a1));
          ctx.closePath();
          ctx.fill(); ctx.stroke();
        }else if (kind==='petal'){
          const mid=(a0+a1)/2;
          ctx.beginPath();
          ctx.moveTo(r1*Math.cos(a0), r1*Math.sin(a0));
          ctx.quadraticCurveTo((r2*1.06)*Math.cos(mid),(r2*1.06)*Math.sin(mid), r1*Math.cos(a1), r1*Math.sin(a1));
          ctx.quadraticCurveTo((r2*0.94)*Math.cos(mid),(r2*0.94)*Math.sin(mid), r1*Math.cos(a0), r1*Math.sin(a0));
          ctx.closePath();
          ctx.fill(); ctx.stroke();
        }else if (kind==='star'){
          const spikes=5, inner=(r1+r2)/2;
          let rot=a0, step=(a1-a0)/ (spikes*2);
          ctx.beginPath();
          for(let i=0;i<spikes*2;i++){
            const rr = (i%2===0) ? r2 : inner;
            ctx.lineTo(rr*Math.cos(rot), rr*Math.sin(rot));
            rot += step;
          }
          ctx.closePath();
          ctx.fill(); ctx.stroke();
        }else if (kind==='wavy'){
          const steps=20; const amp=(r2-r1)*0.35;
          ctx.beginPath();
          for(let i=0;i<=steps;i++){
            const t=i/steps;
            const ang=a0 + (a1-a0)*t;
            const rr=r1 + (r2-r1)*t + Math.sin(t*Math.PI*2)*amp*0.15;
            const x=rr*Math.cos(ang), y=rr*Math.sin(ang);
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          for(let i=steps;i>=0;i--){
            const t=i/steps;
            const ang=a0 + (a1-a0)*t;
            const rr=r1 + Math.sin((t+0.5)*Math.PI*2)*amp*0.1;
            const x=(r1+rr*0.1)*Math.cos(ang), y=(r1+rr*0.1)*Math.sin(ang);
            ctx.lineTo(x,y);
          }
          ctx.closePath();
          ctx.fill(); ctx.stroke();
        }
      }

      function drawDotsTexture(r1,r2,a0,a1, hex, density=6){
        const step = (a1-a0)/density;
        const rr = (r1+r2)/2;
        ctx.save();
        ctx.fillStyle = lighten(hex,0.25,0.5);
        for(let i=0;i<density;i++){
          const ang=a0 + step*i + step/2;
          const rad = rr + (i%2? -1:1) * (r2-r1)*0.15;
          ctx.beginPath();
          ctx.arc(rad*Math.cos(ang), rad*Math.sin(ang), Math.max(1, (r2-r1)*0.07), 0, Math.PI*2);
          ctx.fill();
        }
        ctx.restore();
      }

      function drawKaleidoFrame(c, tMs){
        const rect = canvas.getBoundingClientRect();
        const W = rect.width, H = rect.height;
        const cx = W/2, cy = H/2;
        const shorter = Math.min(W, H);
        const padding = Math.max(12, shorter*0.05);
        const R = Math.max(40, shorter/2 - padding);

        regenFragments(c, R);

        ctx.clearRect(0,0,W,H);
        ctx.save();
        ctx.translate(cx, cy);

        // 動態：慢速旋轉 + 微呼吸
        const t = tMs*0.001;
        const angle = t * KCFG.speed;
        const breathe = 1 + Math.sin(t*0.8) * (KCFG.breathe);
        ctx.rotate(angle);
        ctx.scale(breathe, breathe);

        const wedge = (Math.PI*2)/SYM;

        // 背景細圈
        ctx.save();
        ctx.globalAlpha = 0.08;
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim() || '#888';
        for(let i=0;i<6;i++){
          const r = (R*0.25) + i*(R*0.12);
          ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
        }
        ctx.restore();

        _frags.forEach(f=>{
          const grad = makeRadialGradient(ctx, 0, 0, (f.r1+f.r2)/2, f.color);
          for (let k=0;k<SYM;k++){
            ctx.save();
            ctx.rotate(k*wedge);
            if (k%2===1) ctx.scale(-1,1);
            ctx.globalAlpha = f.alpha;
            drawFrag(f.kind, f.r1, f.r2, f.a0, f.a1, f.color, grad);
            if (f.dots) drawDotsTexture(f.r1,f.r2,f.a0,f.a1, f.color, 6);
            ctx.restore();
          }
        });

        ctx.restore();
      }

      // 動畫 loop
      let _animRaf = null;
      function _loop(ts){
        window._kaleidoFrame = _loop;
        drawKaleidoFrame(lastCounts, ts||performance.now());
        _animRaf = requestAnimationFrame(_loop);
      }
      window._kaleidoFrame = _loop;

      /* ===== 主繪製：依模式切換 ===== */
      function drawAll(c){
        if(!canvas.width || !canvas.height) return;

        if (localStorage.getItem('viewMode')==='kaleido' || viewMode==='kaleido') {
          renderKaleidoHud(c || lastCounts || {});
          if (!_animRaf){ _animRaf = requestAnimationFrame(_loop); }
          return;
        }else{
          if (_animRaf){ cancelAnimationFrame(_animRaf); _animRaf=null; }
        }

        // 正字牆
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0,0,rect.width,rect.height);
        const fgColor = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()
                        || (document.documentElement.getAttribute('data-theme')==='dark' ? '#ffffff' : '#333333');
        ctx.fillStyle = fgColor;
        ctx.font = "bold 14px system-ui";
        const pos = layout();
        ctx.fillText(`想你 (${c.think||0})`, pos.think.x, pos.think.y-6);
        ctx.fillText(`想抱抱 (${c.hug||0})`, pos.hug.x, pos.hug.y-6);
        ctx.fillText(`親親 (${c.kiss||0})`, pos.kiss.x, pos.kiss.y-6);
        ctx.fillText(`靠一下 (${c.lean||0})`, pos.lean.x, pos.lean.y-6);
        ctx.fillText(`搓搓 (${c.rub||0})`, pos.rub.x, pos.rub.y-6);
        ctx.fillText(`打打(扣) (${c.tap||0})`,  pos.tap.x,  pos.tap.y-6);
        const s=1;
        drawTallies(pos.think.x,pos.think.y,COLORS.think,c.think||0,s);
        drawTallies(pos.hug.x,  pos.hug.y, COLORS.hug,  c.hug||0, s);
        drawTallies(pos.kiss.x, pos.kiss.y, COLORS.kiss, c.kiss||0, s);
        drawTallies(pos.lean.x, pos.lean.y, COLORS.lean, c.lean||0, s);
        drawTallies(pos.rub.x,  pos.rub.y, COLORS.rub,  c.rub||0, s);
        drawTallies(pos.tap.x,  pos.tap.y, COLORS.tap,  c.tap||0, s);
      }
      window.drawAll = drawAll;
      window.addEventListener('resize', fitCanvas);

      /* ===== Firestore：牆面資料 ===== */
      const countsRef = doc(db, 'tally-wall', 'global');
      async function ensureCountsDoc(){
        const s = await getDoc(countsRef);
        if (!s.exists()){
          await setDoc(countsRef, { think:0, hug:0, kiss:0, lean:0, rub:0, tap:0, createdAt: Date.now() });
        } else {
          const d = s.data()||{};
          if (typeof d.tap !== 'number'){
            await setDoc(countsRef, { tap: 0 }, { merge:true });
          }
        }
      }
      onSnapshot(countsRef, (snap)=>{
        const d = snap.data()||{};
        lastCounts = { think:d.think||0, hug:d.hug||0, kiss:d.kiss||0, lean:d.lean||0, rub:d.rub||0, tap:d.tap||0 };
        window.lastCounts = lastCounts;
        fitCanvas();
      });

      /* ===== 點擊按鈕（喵喵音效） ===== */
      const meow = document.getElementById('meowSound');
      document.querySelectorAll('.action-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          try{
            await ensureCountsDoc();
            await updateDoc(countsRef, { [btn.dataset.key]: increment(1) });
            if (meow){ meow.currentTime=0; meow.play().catch(()=>{}); }
          }catch(e){
            try{ await ensureCountsDoc(); await updateDoc(countsRef, { [btn.dataset.key]: increment(1) }); }
            catch(err){ showErrorOverlay(err); }
          }
        });
      });

      /* ===== 兌現（全部兌現＋小故事＋打打扣到誰） ===== */
      const btnRedeemOpen = document.getElementById('btnRedeemOpen');
      function showDialog(innerHTML, binder){
        const dlg = document.createElement('dialog');
        dlg.style.background='var(--card)'; dlg.style.color='var(--fg)';
        dlg.style.border='1px solid var(--br)'; dlg.style.borderRadius='12px';
        dlg.style.padding='14px'; dlg.innerHTML = innerHTML;
        document.body.appendChild(dlg);
        try{ dlg.showModal(); }catch{ dlg.setAttribute('open','open'); }
        binder?.(dlg); return dlg;
      }
      function closeDialog(dlg){ if(!dlg) return; if (typeof dlg.close==='function'){ try{ dlg.close(); }catch{} } dlg.remove(); }

      btnRedeemOpen.onclick = async ()=>{
        await ensureCountsDoc(); const s = await getDoc(countsRef); const c = s.data()||{};
        const html = `
          <div style="font-weight:800;margin-bottom:8px">確認兌現</div>
          <div class="muted" style="margin-bottom:6px">會把牆面目前數量全部兌現並歸零。若有「打打(扣)」，可選擇要扣到哪一項：</div>
          <div style="margin-bottom:8px;line-height:1.8">
            想你 <b>${c.think||0}</b>、抱抱 <b>${c.hug||0}</b>、親親 <b>${c.kiss||0}</b>、
            靠一下 <b>${c.lean||0}</b>、搓搓 <b>${c.rub||0}</b>、<span class="muted">打打(扣) <b>${c.tap||0}</b></span>
          </div>
          <label>打打要扣到：
            <select id="tapTarget">
              <option value="think">想你</option>
              <option value="hug">抱抱</option>
              <option value="kiss">親親</option>
              <option value="lean">靠一下</option>
              <option value="rub">搓搓</option>
            </select>
          </label>
          <div id="preview" class="muted" style="margin-top:6px"></div>
          <label style="display:block;margin-top:8px">小故事（選填）
            <textarea id="rStory" rows="4" placeholder="今天我們怎麼兌現的？"></textarea>
          </label>
          <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
            <button id="btnRedeemConfirm">確認兌現</button>
            <button id="btnRedeemCancel">取消</button>
          </div>`;
        const dlg = showDialog(html, (d)=>{
          const sel = d.querySelector('#tapTarget');
          const preview = d.querySelector('#preview');
          function renderPreview(){
            const t = (c.tap||0)>>>0, target = sel.value;
            const base = { think:c.think||0, hug:c.hug||0, kiss:c.kiss||0, lean:c.lean||0, rub:c.rub||0 };
            if (t>0) base[target] = Math.max(0, base[target]-t);
            preview.textContent = `兌現後實得：想你 ${base.think}、抱抱 ${base.hug}、親親 ${base.kiss}、靠一下 ${base.lean}、搓搓 ${base.rub}` + ( (c.tap||0)>0 ? `（打打扣 ${t} → 扣到「${sel.options[sel.selectedIndex].text}」）` : '' );
          }
          renderPreview();
          sel.onchange = renderPreview;

          d.querySelector('#btnRedeemCancel').onclick = ()=> closeDialog(d);
          d.querySelector('#btnRedeemConfirm').onclick = async ()=>{
            const okBtn = d.querySelector('#btnRedeemConfirm');
            okBtn.disabled=true; okBtn.textContent='處理中…';
            try{
              const snap = await getDoc(countsRef);
              const cc = snap.data()||{think:0,hug:0,kiss:0,lean:0,rub:0,tap:0};
              const tapTarget = sel.value;
              const tap = (cc.tap||0)>>>0;
              const applied = { think:cc.think||0, hug:cc.hug||0, kiss:cc.kiss||0, lean:cc.lean||0, rub:cc.rub||0 };
              if (tap>0) applied[tapTarget] = Math.max(0, (applied[tapTarget]||0) - tap);

              const t = new Date();
              const dateId = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
              const story = (d.querySelector('#rStory').value||'').trim();

              await addDoc(collection(db,'redeems'), {
                date: dateId,
                think: applied.think, hug: applied.hug, kiss: applied.kiss, lean: applied.lean, rub: applied.rub,
                tap: tap, tapTarget,
                story, ts: serverTimestamp()
              });

              await setDoc(countsRef, { think:0, hug:0, kiss:0, lean:0, rub:0, tap:0 }, { merge:true });
              await setDoc(doc(db,'last-redeem','time'), { ts: serverTimestamp() });

              closeDialog(d);
              loadSince(); loadSumAll(); loadStatsTable(); loadStories(true);
            }catch(err){ showErrorOverlay(err); okBtn.disabled=false; okBtn.textContent='確認兌現'; }
          };
        });
      };

      /* ===== 倒數 ===== */
      const sinceTxt = document.getElementById('sinceTxt');
      async function loadSince(){
        try{
          const s = await getDoc(doc(db,'last-redeem','time'));
          const t = s.exists() && s.data().ts?.toDate ? s.data().ts.toDate() : null;
          if (!t){ sinceTxt.textContent='尚未兌現'; return; }
          function tick(){
            const diff = Date.now() - t.getTime();
            const days = Math.floor(diff/86400000);
            const hh = String(Math.floor(diff%86400000/3600000)).padStart(2,'0');
            const mm = String(Math.floor(diff%3600000/60000)).padStart(2,'0');
            const ss = String(Math.floor(diff%60000/1000)).padStart(2,'0');
            sinceTxt.textContent = `${days} 天 ${hh}:${mm}:${ss}`;
          }
          tick(); clearInterval(loadSince._timer); loadSince._timer = setInterval(tick,1000);
        }catch{ sinceTxt.textContent='讀取失敗'; }
      }

      /* ===== 累計（全部期間） ===== */
      const sumThink=document.getElementById('sumThink');
      const sumHug=document.getElementById('sumHug');
      const sumKiss=document.getElementById('sumKiss');
      const sumLean=document.getElementById('sumLean');
      const sumRub=document.getElementById('sumRub');
      const sumTap=document.getElementById('sumTap');
      async function loadSumAll(){
        const snap = await getDocs(query(collection(db,'redeems'), orderBy('ts','desc')));
        let T=0,H=0,K=0,L=0,R=0,TP=0;
        snap.forEach(d=>{ const x=d.data()||{}; T+=x.think||0; H+=x.hug||0; K+=x.kiss||0; L+=x.lean||0; R+=x.rub||0; TP+=x.tap||0; });
        sumThink.textContent=T; sumHug.textContent=H; sumKiss.textContent=K; sumLean.textContent=L; sumRub.textContent=R; sumTap.textContent=TP;
      }

      /* ===== 統計表（年/月） ===== */
      const selYear = document.getElementById('selYear');
      const selMonth= document.getElementById('selMonth');
      const tbStats = document.getElementById('tbStats');
      const sumPThink=document.getElementById('sumPThink');
      const sumPHug=document.getElementById('sumPHug');
      const sumPKiss=document.getElementById('sumPKiss');
      const sumPLean=document.getElementById('sumPLean');
      const sumPRub=document.getElementById('sumPRub');
      const sumPTap=document.getElementById('sumPTap');

      async function loadStatsTable(){
        tbStats.innerHTML = `<tr><td colspan="8" class="muted">讀取中…</td></tr>`;
        const yVal = selYear.value, mVal = selMonth.value;
        const qy = query(collection(db,'redeems'), orderBy('date','asc'));
        const snap = await getDocs(qy);
        const rows = []; let sT=0,sH=0,sK=0,sL=0,sR=0,sTP=0;
        snap.forEach(ds=>{
          const d = ds.data()||{}; if (!d.date) return;
          if (yVal && !d.date.startsWith(yVal)) return;
          if (mVal && d.date.slice(5,7)!==mVal) return;
          rows.push(`<tr><td>${d.date}</td><td>${d.think||0}</td><td>${d.hug||0}</td><td>${d.kiss||0}</td><td>${d.lean||0}</td><td>${d.rub||0}</td><td>${d.tap||0}</td><td>${(d.tapTarget||'').toUpperCase()}</td></tr>`);
          sT+=d.think||0; sH+=d.hug||0; sK+=d.kiss||0; sL+=d.lean||0; sR+=d.rub||0; sTP+=d.tap||0;
        });
        tbStats.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="8" class="muted">本期間沒有資料</td></tr>`;
        sumPThink.textContent=sT; sumPHug.textContent=sH; sumPKiss.textContent=sK; sumPLean.textContent=sL; sumPRub.textContent=sR; sumPTap.textContent=sTP;
      }
      (async function initYearMonth(){
        const snap = await getDocs(query(collection(db,'redeems'), orderBy('date','asc')));
        const years = new Set(); const months = new Set([""]);
        snap.forEach(d=>{ const s=(d.data()?.date||""); if (s.length>=7){ years.add(s.slice(0,4)); months.add(s.slice(5,7)); } });
        selYear.innerHTML = `<option value="">全部</option>` + Array.from(years).sort().map(y=>`<option value="${y}">${y}</option>`).join('');
        selMonth.innerHTML = `<option value="">全部</option>` + Array.from(months).filter(Boolean).sort().map(m=>`<option value="${m}">${m}</option>`).join('');
        selYear.onchange=loadStatsTable; selMonth.onchange=loadStatsTable;
        loadStatsTable();
      })();

      /* ===== 匯出 CSV（兌現、留言） & 打包 ZIP ===== */
      function csvEscape(s){ const t=String(s??''); return /[",\r\n]/.test(t) ? `"${t.replace(/"/g,'""')}"` : t; }
      function fmtDT(d){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
        const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'), ss=String(d.getSeconds()).padStart(2,'0');
        return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
      }

      async function exportCsvCurrentRange(){
        const yVal = selYear.value, mVal = selMonth.value;
        const snap = await getDocs(query(collection(db,'redeems'), orderBy('date','asc')));
        const rows=[]; let sT=0,sH=0,sK=0,sL=0,sR=0,sTP=0;
        snap.forEach(ds=>{
          const d=ds.data()||{}; if(!d.date) return;
          if (yVal && !d.date.startsWith(yVal)) return;
          if (mVal && d.date.slice(5,7)!==mVal) return;
          rows.push([d.date, d.think||0, d.hug||0, d.kiss||0, d.lean||0, d.rub||0, d.tap||0, (d.tapTarget||'').toUpperCase(), d.story||'']);
          sT+=(d.think||0); sH+=(d.hug||0); sK+=(d.kiss||0); sL+=(d.lean||0); sR+=(d.rub||0); sTP+=(d.tap||0);
        });
        if(!rows.length){ alert('本期間沒有資料可匯出'); return; }
        const header=['日期','想你','抱抱','親親','靠一下','搓搓','打打(扣)','扣到','小故事'];
        const lines=[ header.map(csvEscape).join(',') ];
        for(const r of rows) lines.push(r.map(csvEscape).join(','));
        lines.push(['合計',sT,sH,sK,sL,sR,sTP,'',''].map(csvEscape).join(','));
        const csv = '\uFEFF' + lines.join('\r\n');
        const now = new Date();
        const ym = yVal ? (mVal ? `${yVal}-${mVal}` : yVal) : '全部';
        const fname = `redeems-${ym}-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.csv`;
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}), url = URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      }
      document.getElementById('btnExportCsv')?.addEventListener('click', exportCsvCurrentRange);

      async function exportNotesCsvCurrentRange(){
        const yVal = selYear.value, mVal = selMonth.value;
        const snap = await getDocs(query(collection(db,'notes'), orderBy('ts','asc')));
        const header=['日期時間','類型','主留言ID','parentId','姓名','留言內容'];
        const lines=[ header.map(csvEscape).join(',') ];
        let count=0;
        snap.forEach(ds=>{
          const id = ds.id;
          const d=ds.data()||{}; const dt=d.ts?.toDate?.(); if(!dt) return;
          const y=String(dt.getFullYear()), m=String(dt.getMonth()+1).padStart(2,'0');
          if (yVal && y!==yVal) return;
          if (mVal && m!==mVal) return;
          const isReply = !!(d.parentId);
          lines.push([ fmtDT(dt), isReply?'回覆':'主留言', isReply? (d.parentId||'') : id, d.parentId||'', d.name||'', d.story||'' ].map(csvEscape).join(','));
          count++;
        });
        if (count===0){ alert('本期間沒有留言可匯出'); return; }
        lines.push(['總筆數', count, '', '', '', ''].map(csvEscape).join(','));
        const csv = '\uFEFF' + lines.join('\r\n');
        const now = new Date();
        const ym = yVal ? (mVal ? `${yVal}-${mVal}` : yVal) : '全部';
        const fname = `notes-${ym}-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.csv`;
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}), url = URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      }
      document.getElementById('btnExportNotesCsv')?.addEventListener('click', exportNotesCsvCurrentRange);

      /* ===== 打包 ZIP ===== */
      let __zipReady = null;
      function loadJSZip(){
        if (__zipReady) return __zipReady;
        __zipReady = new Promise((resolve, reject)=>{
          if (window.JSZip) return resolve(window.JSZip);
          const s=document.createElement('script');
          s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
          s.onload=()=> resolve(window.JSZip);
          s.onerror=()=> reject(new Error('JSZip 載入失敗'));
          document.head.appendChild(s);
        });
        return __zipReady;
      }
      function buildMetaJson(){
        const theme = document.documentElement.getAttribute('data-theme') || 'light';
        const colorPrefs = (()=>{ try{ return JSON.parse(localStorage.getItem('colorPrefs')||'{}'); }catch{ return {}; }})();
        const counts = (typeof lastCounts==='object' && lastCounts) ? lastCounts : {};
        const exportedAt = new Date().toISOString();
        return JSON.stringify({ theme, colorPrefs, counts, exportedAt }, null, 2);
      }
      async function buildRedeemsCsv(yVal, mVal){
        const snap = await getDocs(query(collection(db,'redeems'), orderBy('date','asc')));
        const header=['日期','想你','抱抱','親親','靠一下','搓搓','打打(扣)','扣到','小故事'];
        const lines=[ header.map(csvEscape).join(',') ];
        let sT=0,sH=0,sK=0,sL=0,sR=0,sTP=0;
        snap.forEach(ds=>{
          const d=ds.data()||{}; if(!d.date) return;
          if (yVal && !d.date.startsWith(yVal)) return;
          if (mVal && d.date.slice(5,7)!==mVal) return;
          lines.push([d.date, d.think||0, d.hug||0, d.kiss||0, d.lean||0, d.rub||0, d.tap||0, (d.tapTarget||'').toUpperCase(), d.story||''].map(csvEscape).join(','));
          sT+=d.think||0; sH+=d.hug||0; sK+=d.kiss||0; sL+=d.lean||0; sR+=d.rub||0; sTP+=d.tap||0;
        });
        if (lines.length===1) return null;
        lines.push(['合計', sT, sH, sK, sL, sR, sTP, '', ''].map(csvEscape).join(','));
        return '\uFEFF' + lines.join('\r\n');
      }
      async function buildNotesCsv(yVal, mVal){
        const snap = await getDocs(query(collection(db,'notes'), orderBy('ts','asc')));
        const header=['日期時間','類型','主留言ID','parentId','姓名','留言內容'];
        const lines=[ header.map(csvEscape).join(',') ];
        let count=0;
        snap.forEach(ds=>{
          const id = ds.id;
          const d=ds.data()||{}; const dt=d.ts?.toDate?.(); if(!dt) return;
          const y=String(dt.getFullYear()), m=String(dt.getMonth()+1).padStart(2,'0');
          if (yVal && y!==yVal) return;
          if (mVal && m!==mVal) return;
          const isReply = !!(d.parentId);
          lines.push([ fmtDT(dt), isReply?'回覆':'主留言', isReply? (d.parentId||'') : id, d.parentId||'', d.name||'', d.story||'' ].map(csvEscape).join(','));
          count++;
        });
        if (count===0) return null;
        lines.push(['總筆數', count, '', '', '', ''].map(csvEscape).join(','));
        return '\uFEFF' + lines.join('\r\n');
      }
      async function exportZipAll(){
        try{
          const yVal = selYear.value, mVal = selMonth.value;
          const ymLabel = yVal ? (mVal ? `${yVal}-${mVal}` : yVal) : '全部';
          const [redeemsCsv, notesCsv] = await Promise.all([
            buildRedeemsCsv(yVal, mVal),
            buildNotesCsv(yVal, mVal)
          ]);
          if (!redeemsCsv && !notesCsv){ alert('本期間沒有任何資料可匯出'); return; }
          const meta = buildMetaJson();
          const JSZip = await loadJSZip();
          const zip = new JSZip();
          if (redeemsCsv) zip.file(`redeems-${ymLabel}.csv`, redeemsCsv);
          if (notesCsv)   zip.file(`notes-${ymLabel}.csv`, notesCsv);
          zip.file('meta.json', meta);
          const blob = await zip.generateAsync({ type:'blob' });
          const now = new Date();
          const fname = `tallywall-${ymLabel}-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.zip`;
          const url = URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        }catch(err){ showErrorOverlay(err); }
      }
      document.getElementById('btnExportZip')?.addEventListener('click', exportZipAll);

      /* ===== 小故事 ===== */
      const storiesList = document.getElementById('storiesList');
      const btnMoreStories = document.getElementById('btnMoreStories');
      const selStorySort = document.getElementById('selStorySort');
      let storiesCursor = null; let storiesBuffer = []; let storiesSeen = new Set();
      function storyRowHTML(d){
        const t = d.ts?.toDate?.()||new Date();
        const dt = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
        const safe = (d.story||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const think = d.think||0, hug=d.hug||0, kiss=d.kiss||0, lean=d.lean||0, rub=d.rub||0, tap=d.tap||0;
        const target = (d.tapTarget||'').toUpperCase();
        return `<div style="margin:8px 0;padding:6px 8px;border:1px solid var(--br);border-radius:10px;background:var(--card)">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <strong>${dt}</strong>
            <span>
              <span class="badge think">想你 ${think}</span>
              <span class="badge hug">抱抱 ${hug}</span>
              <span class="badge kiss">親親 ${kiss}</span>
              <span class="badge lean">靠一下 ${lean}</span>
              <span class="badge rub">搓搓 ${rub}</span>
              <span class="badge tap">打打扣 ${tap}${target?` → ${target}`:''}</span>
            </span>
          </div>${safe ? `<div style="margin-top:6px">${safe}</div>` : ``}
        </div>`;
      }
      function applyStorySort(arr, mode){
        const a=[...arr];
        if (mode==='ts_asc') a.sort((x,y)=> (x.ts?.toMillis?.()||0) - (y.ts?.toMillis?.()||0));
        else if (mode==='total_desc') a.sort((x,y)=> ((y.think||0)+(y.hug||0)+(y.kiss||0)+(y.lean||0)+(y.rub||0)) - ((x.think||0)+(x.hug||0)+(x.kiss||0)+(x.lean||0)+(x.rub||0)));
        else if (mode==='rub_desc') a.sort((x,y)=> (y.rub||0) - (x.rub||0));
        else a.sort((x,y)=> (y.ts?.toMillis?.()||0) - (x.ts?.toMillis?.()||0)); // ts_desc
        return a;
      }
      async function loadStories(reset=false){
        if (reset){ storiesCursor=null; storiesBuffer=[]; storiesSeen.clear(); storiesList.innerHTML=''; }
        let qy = query(collection(db,'redeems'), orderBy('ts','desc'), limit(20));
        if (storiesCursor){ qy = query(collection(db,'redeems'), orderBy('ts','desc'), startAfter(storiesCursor), limit(20)); }
        const snap = await getDocs(qy);
        if (snap.empty && !storiesCursor){ storiesList.innerHTML = `<div class="muted">尚無紀錄</div>`; return; }
        let last=null;
        snap.forEach(ds=>{
          const id = ds.id;
          if (storiesSeen.has(id)) return;
          const data = ds.data()||{}; data.__id=id;
          storiesBuffer.push(data); storiesSeen.add(id); last = ds;
        });
        if (last) storiesCursor = last;
        storiesList.innerHTML = applyStorySort(storiesBuffer, selStorySort?.value || 'ts_desc').map(storyRowHTML).join('');
      }
      btnMoreStories.onclick = ()=> loadStories(false);
      selStorySort?.addEventListener('change', ()=> loadStories(true));

      /* ===== 顏色客製 ===== */
      document.getElementById('btnColorCfg').addEventListener('click', ()=>{
        const cur = { think: cssVar('--c-think'), hug: cssVar('--c-hug'), kiss: cssVar('--c-kiss'), lean: cssVar('--c-lean'), rub: cssVar('--c-rub'), tap: cssVar('--c-tap') };
        const html = `<div style="font-weight:800;margin-bottom:8px">顏色設定</div>
          <div class="toolbar" style="flex-direction:column;gap:10px">
            <label>想你 <input id="colThink" type="color" value="${tinyHex(cur.think)}"></label>
            <label>抱抱 <input id="colHug"   type="color" value="${tinyHex(cur.hug)}"></label>
            <label>親親 <input id="colKiss"  type="color" value="${tinyHex(cur.kiss)}"></label>
            <label>靠一下 <input id="colLean" type="color" value="${tinyHex(cur.lean)}"></label>
            <label>搓搓 <input id="colRub"   type="color" value="${tinyHex(cur.rub)}"></label>
            <label>打打(扣) <input id="colTap"   type="color" value="${tinyHex(cur.tap)}"></label>
          </div>
          <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
            <button id="btnColorSave">儲存</button>
            <button id="btnColorCancel">取消</button>
          </div>`;
        const dlg = showDialog(html, (d)=>{
          d.querySelector('#btnColorCancel').onclick = ()=> closeDialog(d);
          d.querySelector('#btnColorSave').onclick = ()=>{
            const vals = {
              '--c-think': d.querySelector('#colThink').value,
              '--c-hug':   d.querySelector('#colHug').value,
              '--c-kiss':  d.querySelector('#colKiss').value,
              '--c-lean':  d.querySelector('#colLean').value,
              '--c-rub':   d.querySelector('#colRub').value,
              '--c-tap':   d.querySelector('#colTap').value
            };
            const curr = JSON.parse(localStorage.getItem('colorPrefs')||'{}');
            localStorage.setItem('colorPrefs', JSON.stringify({...curr, ...vals}));
            for(const [k,v] of Object.entries(vals)){ setCssVar(k, v); }
            COLORS = readColors(); drawAll(lastCounts);
            loadStories(true);
            closeDialog(d);
          };
        });
      });
      (function loadColorPrefs(){
        try{
          const raw = localStorage.getItem('colorPrefs'); if(!raw) return;
          const obj = JSON.parse(raw)||{}; for(const [k,v] of Object.entries(obj)){ setCssVar(k, v); }
          COLORS = readColors(); drawAll(lastCounts);
        }catch{}
      })();

      /* ===== 只是單獨留言（姓名＋內容）＋回覆 ===== */
      const notesList = document.getElementById('notesList');
      const btnMoreNotes = document.getElementById('btnMoreNotes');
      let notesCursor = null; let notesSeen = new Set();

      function toast(msg){
        const t=document.createElement('div');
        t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.top='16px'; t.style.transform='translateX(-50%)';
        t.style.padding='8px 12px'; t.style.background='var(--card)'; t.style.color='var(--fg)';
        t.style.border='1px solid var(--br)'; t.style.borderRadius='10px'; t.style.zIndex='9999';
        document.body.appendChild(t); setTimeout(()=> t.remove(), 1600);
      }
      function esc(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      (function setupNotesPost(){
        const btnPostNoteOpen = document.getElementById('btnPostNoteOpen');
        if (!btnPostNoteOpen){ console.warn('#btnPostNoteOpen 找不到'); return; }

        function closeDialog(dlg){ if(!dlg) return; if (typeof dlg.close==='function'){ try{ dlg.close(); }catch{} } dlg.remove(); }

        async function submitNote(name, story, parentId, dlg){
          try{
            await addDoc(collection(db,'notes'), {
              name: (name||'').trim(), story: (story||'').trim(), parentId: parentId ?? null, ts: serverTimestamp()
            });
            if (dlg) closeDialog(dlg);
            if (parentId){
              const container = document.querySelector(`[data-note-id="${parentId}"] .replies`);
              if (container) await loadReplies(parentId, container);
              toast('回覆已送出！');
            }else{
              loadNotes(true);
              toast('留言已送出！');
            }
          }catch(err){
            showErrorOverlay(err);
            if (dlg){ const btn=dlg.querySelector('#btnConfirm'); if(btn){ btn.disabled=false; btn.textContent='送出'; } }
          }
        }

        function openDialog(title, onSubmit, presetName=''){
          const html = `<div style="font-weight:800;margin-bottom:8px">${title}</div>
            <label>姓名（可留空）
              <input id="name" type="text" placeholder="例如 Karen / 我" value="${esc(presetName)}">
            </label>
            <label style="margin-top:8px">小故事 / 留言
              <textarea id="story" rows="4" placeholder="寫點什麼吧～"></textarea>
            </label>
            <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
              <button id="btnConfirm">送出</button>
              <button id="btnCancel">取消</button>
            </div>`;
          const dlg = document.createElement('dialog');
          dlg.style.background='var(--card)'; dlg.style.color='var(--fg)';
          dlg.style.border='1px solid var(--br)'; dlg.style.borderRadius='12px';
          dlg.style.padding='14px'; dlg.innerHTML = html;
          document.body.appendChild(dlg);
          try{ dlg.showModal(); }catch{ dlg.setAttribute('open','open'); }
          dlg.querySelector('#btnCancel').onclick = ()=> { try{ dlg.close(); }catch{} dlg.remove(); };
          dlg.querySelector('#btnConfirm').onclick = ()=>{
            const name = dlg.querySelector('#name').value.trim();
            const story = dlg.querySelector('#story').value.trim();
            if (!story){ alert('請先寫點內容喔～'); return; }
            dlg.querySelector('#btnConfirm').disabled = true; dlg.querySelector('#btnConfirm').textContent='送出中…';
            onSubmit(name, story, dlg);
          };
          setTimeout(()=> dlg.querySelector('#story')?.focus(), 0);
        }

        btnPostNoteOpen.replaceWith(btnPostNoteOpen.cloneNode(true));
        document.getElementById('btnPostNoteOpen').addEventListener('click', ()=>{
          openDialog('只是單獨留言', (name, story, dlg)=> submitNote(name, story, null, dlg));
        });

        window.__openReplyFor = function(noteId, presetName=''){
          openDialog('回覆留言', (name, story, dlg)=> submitNote(name, story, noteId, dlg), presetName);
        };
      })();

      function noteRowHTML(id, d){
        const t = d.ts?.toDate?.()||new Date();
        const dt = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
        const name = esc(d.name||'');
        const story = esc(d.story||'');
        return `<div class="note" data-note-id="${id}" style="margin:8px 0;padding:8px 10px;border:1px solid var(--br);border-radius:10px;background:var(--card)">
          <div><strong>${dt}</strong>${name?` <span class="muted">・${name}</span>`:''}</div>
          <div style="margin-top:4px">${story}</div>
          <div class="toolbar" style="margin-top:6px">
            <button class="btnReply" data-id="${id}">回覆</button>
            <button class="btnShowReplies ghost" data-id="${id}">顯示回覆</button>
          </div>
          <div class="replies" style="margin-top:6px;display:none"></div>
        </div>`;
      }

      async function loadReplies(noteId, container){
        container.innerHTML = `<div class="muted">讀取回覆中…</div>`;
        const snap = await getDocs(query(collection(db,'notes'), where('parentId','==', noteId), orderBy('ts','asc')));
        if (snap.empty){ container.innerHTML = `<div class="muted">目前沒有回覆</div>`; return; }
        const html=[];
        snap.forEach(ds=>{
          const d = ds.data()||{};
          const t = d.ts?.toDate?.()||new Date();
          const dt = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
          const name = esc(d.name||'');
          const story = esc(d.story||'');
          html.push(`<div class="reply" style="margin:6px 0">
            <strong>${dt}</strong>${name?` <span class="muted">・${name}</span>`:''}<br>${story}
          </div>`);
        });
        container.innerHTML = html.join('');
      }

      async function loadNotes(reset=false){
	  if (reset){ notesCursor=null; notesSeen.clear(); notesList.innerHTML=''; }

	  // 不再用 where('parentId','==', null)；有些舊文沒有 parentId 欄位
	  let qy = query(collection(db,'notes'), orderBy('ts','desc'), limit(20));
	  if (notesCursor){
		qy = query(collection(db,'notes'), orderBy('ts','desc'), startAfter(notesCursor), limit(20));
	  }

	  const snap = await getDocs(qy);
	  if (snap.empty && !notesCursor){
		notesList.innerHTML = `<div class="muted">尚無留言</div>`;
		return;
	  }

	  let last=null; const html=[];
	  snap.forEach(ds=>{
		const id = ds.id;
		if (notesSeen.has(id)) return;
		const d = ds.data()||{};

		// 主留言判斷：有 parentId 就得是 null；沒有 parentId 欄位也視為主留言
		const isRoot = (Object.prototype.hasOwnProperty.call(d, 'parentId')) ? (d.parentId === null) : (!d.parentId);
		if (!isRoot) return;

		notesSeen.add(id);
		html.push(noteRowHTML(id, d));
		last = ds;
	  });

	  if (!html.length && !notesCursor){
		notesList.innerHTML = `<div class="muted">尚無留言</div>`;
		return;
	  }

	  if (last) notesCursor = last;

	  const frag = document.createElement('div'); frag.innerHTML = html.join('');
	  frag.querySelectorAll('.btnReply').forEach(b=>{
		b.addEventListener('click', ()=>{
		  const id = b.getAttribute('data-id');
		  window.__openReplyFor(id);
		});
	  });
	  frag.querySelectorAll('.btnShowReplies').forEach(b=>{
		b.addEventListener('click', async ()=>{
		  const id = b.getAttribute('data-id');
		  const wrap = b.closest('[data-note-id]');
		  const container = wrap.querySelector('.replies');
		  if (container.style.display==='none'){
			container.style.display='block';
			await loadReplies(id, container);
			b.textContent='隱藏回覆';
		  }else{
			container.style.display='none';
			b.textContent='顯示回覆';
		  }
		});
	  });
	  notesList.appendChild(frag);
	}
      document.getElementById('btnMoreNotes').onclick = ()=> loadNotes(false);

      /* ===== 啟動 ===== */
      await ensureCountsDoc();
      loadSince(); loadSumAll(); loadStatsTable(); loadStories(true); loadNotes(true);
      fitCanvas();

      // 初始就處於萬花筒模式時，啟動動畫
      if (localStorage.getItem('viewMode')==='kaleido'){ if (typeof window._kaleidoFrame==='function') requestAnimationFrame(window._kaleidoFrame); }

    }catch(err){
      showErrorOverlay('Firebase 載入失敗：' + (err && (err.message||err)));
    }
  };

  // 若上次已通過解鎖，開頁就先初始化
  if (localStorage.getItem('app-should-init') === '1') {
    try { window.__afterUnlock(); } finally { localStorage.removeItem('app-should-init'); }
  }
</script>

</body>
</html>
