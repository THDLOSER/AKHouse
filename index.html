<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>想你牆 — 問答解鎖（65 歲）</title>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --card:#fafafa; --br:#e9e9e9; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto}
    header{padding:16px 20px;font-weight:800;font-size:18px;border-bottom:1px solid var(--br)}
    .wrap{display:flex;flex-direction:column;gap:14px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:680px;margin:0 auto;width:100%}
    button{padding:14px 12px;border:1px solid var(--br);border-radius:12px;background:var(--card);cursor:pointer;font-size:16px;font-weight:700;transition:transform .06s ease, background .2s}
    button:active{transform:scale(.98)}
    .section{max-width:1100px;margin:0 auto;width:100%}
    .canvas-wrap{border:1px dashed var(--br);border-radius:12px;padding:10px;background:#fff}
    #wall{width:100%;height:48vh;display:block}
    .legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;margin:6px 0 0}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--br);border-radius:999px;padding:6px 10px;background:#fff}
    .dot{width:8px;height:8px;border-radius:50%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{border:1px solid var(--br);border-radius:12px;padding:12px;background:#fff}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--br);padding:8px 10px;text-align:right}
    th:first-child, td:first-child{text-align:left}
    .hidden{display:none}
    dialog{border:1px solid var(--br);border-radius:14px;padding:0;max-width:520px}
    dialog header{font-size:16px;padding:12px 14px;border-bottom:1px solid var(--br)}
    dialog .body{padding:14px}
    input[type="text"], textarea, select{width:100%;box-sizing:border-box;border:1px solid var(--br);border-radius:10px;padding:10px;font-size:16px;background:#fff}
    textarea{resize:vertical}
    /* 並排圖表與表格 */
    .chart-and-table{display:block}
    @media(min-width:900px){.chart-and-table{display:grid;grid-template-columns:1.2fr .8fr;gap:10px}}
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filters label{font-size:14px;color:#444}
  </style>
</head>
<body>
  <!-- 軟綿綿喵喵叫音效：請把 meow.mp3 放在與本檔相同資料夾 -->
  <audio id="meowSound" src="meow.mp3" preload="auto"></audio>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div>記在牆上（Aether & Karen）</div>
    <button id="btnResetGate" style="font-size:14px;padding:6px 10px">🔒 重新驗證</button>
  </header>
  <div class="wrap">

    <!-- 問答解鎖：我們約定好幾歲？ -->
    <div id="gate" class="section card">
      <div style="font-weight:800;margin-bottom:6px">我們約定好幾歲？</div>
      <div class="row" style="margin-top:8px">
        <input id="answer" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="3" placeholder="請輸入數字（提示：兩位數）" />
        <button id="btnGate">開始</button>
      </div>
      <div id="gateMsg" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- 主操作區 -->
    <div id="main" class="section hidden">
      <div class="grid">
        <button data-key="think">🩷 想你</button>
        <button data-key="hug">🤗 想抱抱</button>
        <button data-key="kiss">😘 親親</button>
        <button data-key="lean">🫴 靠一下</button>
      </div>

      <div class="canvas-wrap" style="margin-top:8px">
        <canvas id="wall"></canvas>
        <div class="legend">
          <span class="chip"><span class="dot" style="background:#ff6aa2"></span>想你</span>
          <span class="chip"><span class="dot" style="background:#6aa8ff"></span>抱抱</span>
          <span class="chip"><span class="dot" style="background:#7bd88f"></span>親親</span>
          <span class="chip"><span class="dot" style="background:#f7c84b"></span>靠一下</span>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="row">
          <button id="btnOpenRedeem">🎁 全部兌現</button>
          <div class="card" style="flex:1">
            <div class="muted">距離上次兌現已過：</div>
            <div id="since" style="font-weight:800;font-size:18px">—</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">目前累計已兌現（全部期間）</div>
          <div id="totalBox" class="muted">—</div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:8px">
            <div style="font-weight:800">兌現統計（按日期彙總，可篩選）</div>
            <div class="filters">
              <label>年分
                <select id="yearSelect"></select>
              </label>
              <label>月份
                <select id="monthSelect">
                  <option value="all">全部</option>
                  <option value="1">1 月</option>
                  <option value="2">2 月</option>
                  <option value="3">3 月</option>
                  <option value="4">4 月</option>
                  <option value="5">5 月</option>
                  <option value="6">6 月</option>
                  <option value="7">7 月</option>
                  <option value="8">8 月</option>
                  <option value="9">9 月</option>
                  <option value="10">10 月</option>
                  <option value="11">11 月</option>
                  <option value="12">12 月</option>
                </select>
              </label>
              <div class="muted" id="periodTotal" style="min-width:220px"></div>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>日期</th>
                <th>想你</th>
                <th>抱抱</th>
                <th>親親</th>
                <th>靠一下</th>
              </tr>
            </thead>
            <tbody id="statsBody"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">兌現小故事（無限載入）</div>
          <div id="storiesList" class="muted">尚無紀錄</div>
          <div style="text-align:center;margin-top:8px">
            <button id="btnMoreStories" class="hidden">載入更多小故事</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 全部兌現對話框：預覽目前數量 + 小故事 -->
  <dialog id="dlgRedeem">
    <header>確認全部兌現</header>
    <div class="body">
      <div id="redeemPreview" class="card" style="margin-bottom:10px"></div>
      <label style="display:block;margin-top:6px">小故事（選填）
        <textarea id="rStory" rows="4" placeholder="想記一下今天怎麼兌現的嗎？"></textarea>
      </label>
      <div class="muted" style="margin-top:8px">提示：本次將把牆上目前的所有數量一次兌現並歸零。</div>
    </div>
    <div class="actions" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--br)">
      <button id="btnCancelRedeem">取消</button>
      <button id="btnConfirmRedeem">確認兌現</button>
    </div>
  </dialog>

  <script type="module">
    // ===== 1) 換成你的 Firebase 設定 =====
	const firebaseConfig = {
	  apiKey: "AIzaSyAiJTyJGBZIOQW9KAmBUNbxdBFJFr2ABuc",
	  authDomain: "aether-karen-board.firebaseapp.com",
	  projectId: "aether-karen-board",
	  storageBucket: "aether-karen-board.firebasestorage.app",
	  messagingSenderId: "907550532349",
	  appId: "1:907550532349:web:c6bf67c8b86d44e3841494",
	  measurementId: "G-Y91SWR8FBQ"
	};

    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment,
      collection, getDocs, query, orderBy, serverTimestamp, addDoc, limit, startAfter
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ====================== 小工具/通用函式 ======================
    const sinceEl = document.getElementById('since');
    const dlg = document.getElementById('dlgRedeem');
    const btnOpenRedeem = document.getElementById('btnOpenRedeem');
    const btnCancelRedeem = document.getElementById('btnCancelRedeem');
    const btnConfirmRedeem = document.getElementById('btnConfirmRedeem');
    const preview = document.getElementById('redeemPreview');
    const meow = document.getElementById('meowSound');

    // 對話框相容處理
    function openModal(){ if (typeof dlg.showModal === 'function') dlg.showModal(); else dlg.setAttribute('open',''); }
    function closeModal(){ if (typeof dlg.close === 'function') dlg.close(); else dlg.removeAttribute('open'); }

    function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }

    // 倒數計時
    let sinceTimer=null;
    function startSinceTimer(last){
      if (sinceTimer) clearInterval(sinceTimer);
      function render(){
        const now = new Date();
        let s = Math.max(0, Math.floor((now - last)/1000));
        const days = Math.floor(s/86400); s%=86400; const hrs=Math.floor(s/3600); s%=3600; const mins=Math.floor(s/60); const secs=s%60;
        const parts = [];
        if (days>0) parts.push(`${days} 天`);
        parts.push(`${String(hrs).padStart(2,'0')}小時 ${String(mins).padStart(2,'0')}分 ${String(secs).padStart(2,'0')}秒`);
        sinceEl.textContent = parts.join(' ');
      }
      render();
      sinceTimer = setInterval(render,1000);
    }

    // ====================== 問答解鎖（65） ======================
    const gate = document.getElementById('gate');
    const main = document.getElementById('main');
    const answerInput = document.getElementById('answer');
    const gateBtn = document.getElementById('btnGate');
    const gateMsg = document.getElementById('gateMsg');

    function openMain(){ gate.classList.add('hidden'); main.classList.remove('hidden'); }

    function normalizeDigits(s){
      // 全形數字轉半形
      return (s||'').replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 48));
    }

    function tryUnlock(){
      const raw = (answerInput.value||'').trim();
      const norm = normalizeDigits(raw);
      const val = parseInt(norm, 10);
      if (Number.isNaN(val)){ gateMsg.textContent = '請輸入數字'; return; }
      if (val !== 65){ gateMsg.textContent = '答錯囉～再想想 ❤'; return; }
      localStorage.setItem('gate-ok','1');
      openMain();
    }

    gateBtn.addEventListener('click', tryUnlock);
    answerInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') tryUnlock(); });

    if (localStorage.getItem('gate-ok') === '1') openMain();

    // ====================== 正字牆（Firestore 計數） ======================
    const COUNTS_PATH = { col: 'tally-wall', id: 'global' };
    const countsRef = doc(db, COUNTS_PATH.col, COUNTS_PATH.id);
    async function ensureCountsDoc(){
      const snap = await getDoc(countsRef);
      if (!snap.exists()) await setDoc(countsRef, { think:0, hug:0, kiss:0, lean:0, createdAt: Date.now() });
    }

    const canvas = document.getElementById('wall');
    const ctx = canvas.getContext('2d', { alpha: true });
    const COLORS = { think: '#ff6aa2', hug: '#6aa8ff', kiss: '#7bd88f', lean: '#f7c84b' };

    function fitCanvas(){
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      drawAll(lastCounts);
    }
    window.addEventListener('resize', fitCanvas);

    function drawGroup(x, y, color, scale=1){
      const w = 34*scale, h = 28*scale, gap = 6*scale; const top=y, bottom=y+h;
      ctx.strokeStyle = color; ctx.lineWidth = 2;
      for (let i=0;i<4;i++){ const xi = x + i*gap + 2*i; ctx.beginPath(); ctx.moveTo(xi, top); ctx.lineTo(xi, bottom); ctx.stroke(); }
      ctx.beginPath(); ctx.moveTo(x-2, bottom-2); ctx.lineTo(x+gap*3+6, top+2);
      ctx.stroke(); return {w,h};
    }
    function drawTallies(startX,startY,color,count,scale=1,maxPerRow=12){
      let x=startX, y=startY; const groupSize=5, spacingX=40*scale, spacingY=38*scale;
      const groups=Math.floor(count/groupSize), remain=count%groupSize;
      for(let i=0;i<groups;i++){ drawGroup(x,y,color,scale); x+=spacingX; if((i+1)%maxPerRow===0){x=startX; y+=spacingY;} }
      if (remain>0){ const top=y, bottom=y+28*scale; ctx.strokeStyle=color; ctx.lineWidth=2; const gap=6*scale; for(let i=0;i<remain;i++){const xi=x+i*gap+2*i; ctx.beginPath(); ctx.moveTo(xi, top); ctx.lineTo(xi, bottom); ctx.stroke();} }
    }
    function layout(){ const rect=canvas.getBoundingClientRect(); const margin=18; const midX=rect.width/2, midY=rect.height/2; return { think:{x:margin,y:margin}, hug:{x:midX+margin/2,y:margin}, kiss:{x:margin,y:midY+margin/2}, lean:{x:midX+margin/2,y:midY+margin/2} } }

    let lastCounts = { think:0, hug:0, kiss:0, lean:0 };
    function drawAll(c){ if(!canvas.width||!canvas.height) return; const rect=canvas.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height); ctx.fillStyle="#666"; ctx.font="bold 14px system-ui"; const pos=layout(c); ctx.fillText(`想你 (${c.think||0})`, pos.think.x, pos.think.y-6); ctx.fillText(`想抱抱 (${c.hug||0})`, pos.hug.x, pos.hug.y-6); ctx.fillText(`親親 (${c.kiss||0})`, pos.kiss.x, pos.kiss.y-6); ctx.fillText(`靠一下 (${c.lean||0})`, pos.lean.x, pos.lean.y-6); const scale=1; drawTallies(pos.think.x,pos.think.y,COLORS.think,c.think||0,scale); drawTallies(pos.hug.x,pos.hug.y,COLORS.hug,c.hug||0,scale); drawTallies(pos.kiss.x,pos.kiss.y,COLORS.kiss,c.kiss||0,scale); drawTallies(pos.lean.x,pos.lean.y,COLORS.lean,c.lean||0,scale); }

    // ====================== 兌現（全部兌現 + 歸零） ======================
    const lastRedeemRef = doc(db,'last-redeem','time');

    btnOpenRedeem.addEventListener('click', async ()=>{
      await ensureCountsDoc();
      const snap = await getDoc(countsRef);
      const c = snap.data() || {think:0,hug:0,kiss:0,lean:0};
      preview.innerHTML = `目前將兌現：想你 <b>${c.think||0}</b>、抱抱 <b>${c.hug||0}</b>、親親 <b>${c.kiss||0}</b>、靠一下 <b>${c.lean||0}</b>`;
      openModal();
    });
    btnCancelRedeem.addEventListener('click', ()=> closeModal());

    btnConfirmRedeem.addEventListener('click', async ()=>{
      const originalText = btnConfirmRedeem.textContent;
      btnConfirmRedeem.disabled = true; btnConfirmRedeem.textContent = '處理中…';
      try{
        await ensureCountsDoc();
        const story = (document.getElementById('rStory').value||'').trim();
        const snap = await getDoc(countsRef);
        const c = snap.data() || {think:0,hug:0,kiss:0,lean:0};
        const sum = (c.think||0)+(c.hug||0)+(c.kiss||0)+(c.lean||0);
        if (sum===0 && !story){ alert('目前沒有可兌現的數量，請先按幾下或寫一段小故事喔'); return; }

        const dateId = ymd(new Date());
        await addDoc(collection(db,'redeems'),{ date: dateId, think:c.think||0, hug:c.hug||0, kiss:c.kiss||0, lean:c.lean||0, story, ts: serverTimestamp() });
        await setDoc(countsRef,{ think:0,hug:0,kiss:0,lean:0 },{ merge:true });
        await setDoc(lastRedeemRef,{ ts: serverTimestamp() });

        document.getElementById('rStory').value='';
        closeModal();
        await loadStats();
        await loadStoryPage(true);
      }catch(e){
        console.error(e);
        alert('兌現失敗：' + (e?.message || e));
      }finally{
        btnConfirmRedeem.disabled = false; btnConfirmRedeem.textContent = originalText;
      }
    });

    // 倒數：監聽最後兌現時間
    onSnapshot(lastRedeemRef,(snap)=>{
      const d = snap.data();
      const ts = d?.ts?.toDate?.();
      if (ts) startSinceTimer(ts);
    });

    // ====================== 統計（依日期彙總 + 無限小故事 + 圖表＋月份/年分） ======================
    const statsBody = document.getElementById('statsBody');
    const storiesList = document.getElementById('storiesList');
    const totalBox = document.getElementById('totalBox');
    const btnMoreStories = document.getElementById('btnMoreStories');
    const periodTotal = document.getElementById('periodTotal');
    const btnResetGate = document.getElementById('btnResetGate');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    
    let masterEntries = []; // 全部兌現（依日期聚合後的陣列）
    let masterTotals = {think:0,hug:0,kiss:0,lean:0};

    function filterBySelection(){
      const year = parseInt(yearSelect.value,10);
      const mval = monthSelect.value; // 'all' 或 1..12
      const filtered = masterEntries.filter(e=>{
        const [y,mm,dd] = e.date.split('-').map(Number);
        if (y !== year) return false;
        if (mval !== 'all' && mm !== parseInt(mval,10)) return false;
        return true;
      });
      // 表格
      if (filtered.length===0){
        statsBody.innerHTML = '<tr><td colspan="5" class="muted">此期間無兌現紀錄</td></tr>';
      } else {
        statsBody.innerHTML = filtered.map(v=>`<tr><td>${v.date}</td><td>${v.think}</td><td>${v.hug}</td><td>${v.kiss}</td><td>${v.lean}</td></tr>`).join('');
      }
      // 圖表已移除
      // 期間累計
      const pt = filtered.reduce((acc,v)=>{ acc.think+=v.think||0;acc.hug+=v.hug||0;acc.kiss+=v.kiss||0;acc.lean+=v.lean||0; return acc; },{think:0,hug:0,kiss:0,lean:0});
      periodTotal.textContent = `本期間累計：想你 ${pt.think}、抱抱 ${pt.hug}、親親 ${pt.kiss}、靠一下 ${pt.lean}`;
    }

    function populateYearOptions(){
      if (!yearSelect) return;
      const years = Array.from(new Set(masterEntries.map(e=> Number(e.date.slice(0,4))))).sort((a,b)=>a-b);
      yearSelect.innerHTML = years.map(y=>`<option value="${y}">${y} 年</option>`).join('');
      const nowY = new Date().getFullYear();
      if (years.includes(nowY)) yearSelect.value = String(nowY); else yearSelect.value = String(years[years.length-1]||nowY);
    }

    async function loadStats(){
      // 牆即時
      onSnapshot(countsRef,(snap)=>{
        const d=snap.data()||{}; lastCounts = { think:d.think||0, hug:d.hug||0, kiss:d.kiss||0, lean:d.lean||0 }; fitCanvas();
      });

      statsBody.innerHTML = '<tr><td colspan="5" class="muted">讀取中…</td></tr>';
      if (storiesList) storiesList.textContent = '讀取中…';

      const q = query(collection(db,'redeems'), orderBy('date','asc'));
      const snap = await getDocs(q);
      const byDate = new Map();
      masterTotals = { think:0, hug:0, kiss:0, lean:0 };
      snap.forEach(docSnap=>{
        const d = docSnap.data()||{};
        const key = d.date || '未知日期';
        const agg = byDate.get(key) || {think:0,hug:0,kiss:0,lean:0};
        agg.think += d.think||0; agg.hug += d.hug||0; agg.kiss += d.kiss||0; agg.lean += d.lean||0;
        byDate.set(key, agg);
        masterTotals.think += d.think||0; masterTotals.hug += d.hug||0; masterTotals.kiss += d.kiss||0; masterTotals.lean += d.lean||0;
      });

      // 全期間累計顯示
      if (totalBox){ totalBox.textContent = `想你 ${masterTotals.think}、抱抱 ${masterTotals.hug}、親親 ${masterTotals.kiss}、靠一下 ${masterTotals.lean}`; }

      // 轉成排序陣列
      masterEntries = Array.from(byDate.entries()).map(([date,v])=>({date,...v}));
      masterEntries.sort((a,b)=> a.date.localeCompare(b.date));

      populateYearOptions();
      filterBySelection();

      // 小故事：先載入第一頁
      await loadStoryPage(true);
    }

    // 年/月變更 → 重新套用篩選
    document.addEventListener('change', (e)=>{
      if (e.target===yearSelect || e.target===monthSelect) filterBySelection();
    });

    // ========= 小故事無限載入 =========
    let storyCursor = null; const STORY_PAGE = 20;
    async function loadStoryPage(reset=false){
      try{
        if (!storiesList || !btnMoreStories) return;
        if (reset){ storiesList.innerHTML = ''; storyCursor = null; btnMoreStories.classList.add('hidden'); }
        let qy = query(collection(db,'redeems'), orderBy('ts','desc'), limit(STORY_PAGE));
        if (storyCursor) qy = query(collection(db,'redeems'), orderBy('ts','desc'), startAfter(storyCursor), limit(STORY_PAGE));
        const snap = await getDocs(qy);
        if (snap.empty){ if (reset) storiesList.textContent = '尚無紀錄'; return; }
        const docs = snap.docs; storyCursor = docs[docs.length-1];
        const html = docs.map(docSnap=>{
          const d = docSnap.data()||{};
          const dt = d.ts?.toDate?.() || new Date();
          const y = dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const dd=String(dt.getDate()).padStart(2,'0');
          const hh=String(dt.getHours()).padStart(2,'0'); const mm=String(dt.getMinutes()).padStart(2,'0');
          const story = (d.story||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return `<div style="margin:6px 0"><strong>${y}-${m}-${dd} ${hh}:${mm}</strong>（想你${d.think||0} 抱抱${d.hug||0} 親親${d.kiss||0} 靠一下${d.lean||0}）<br>${story}</div>`;
        }).join('');
        storiesList.insertAdjacentHTML('beforeend', html);
        if (docs.length === STORY_PAGE) btnMoreStories.classList.remove('hidden');
        else btnMoreStories.classList.add('hidden');
      }catch(err){ storiesList.textContent = '讀取失敗，請稍後再試'; console.error(err); }
    }

    if (document.getElementById('btnMoreStories')){
      btnMoreStories.addEventListener('click', ()=> loadStoryPage(false));
    }

    // 重新驗證按鈕（清除 gate-ok）
    if (btnResetGate){
      btnResetGate.addEventListener('click', ()=>{
        localStorage.removeItem('gate-ok');
        const g = document.getElementById('gate');
        const m = document.getElementById('main');
        if (g && m){ m.classList.add('hidden'); g.classList.remove('hidden'); }
        const msg = document.getElementById('gateMsg');
        if (msg) msg.textContent = '已重置，請重新回答：我們約定好幾歲？';
        const ans = document.getElementById('answer'); if (ans) ans.value='';
      });
    }

    // 支援網址加上 ?reset=1 強制顯示驗證
    try{ const u = new URL(window.location.href); if (u.searchParams.get('reset')==='1'){ localStorage.removeItem('gate-ok'); } }catch(_){ }

    // ====================== 初始化（先匿名登入，成功後再載入資料） ======================
    signInAnonymously(auth).catch((e)=>{
      console.error('匿名登入失敗', e);
      const m = document.getElementById('gateMsg');
      if (m) m.textContent = '匿名登入失敗：' + (e?.code || e?.message || '未知錯誤');
      alert('匿名登入失敗，請稍後再試或檢查 Firebase Authentication 是否已啟用 Anonymous。');
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;
      try{
        await ensureCountsDoc();
        await loadStats();
      }catch(e){ console.error(e); }
    });

    // ====================== 按鈕計數 ======================
    document.querySelectorAll('button[data-key]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        // 播放喵喵音效（軟綿綿）
        try{ if (meow){ meow.currentTime = 0; await meow.play(); } }catch(_){ /* 某些瀏覽器需使用者互動後才可播放，可忽略錯誤 */ }
        try{
          await updateDoc(countsRef, { [btn.dataset.key]: increment(1) });
        }catch(e){
          await ensureCountsDoc();
          await updateDoc(countsRef, { [btn.dataset.key]: increment(1) });
        }
      });
    });

  </script>
</body>
</html>
