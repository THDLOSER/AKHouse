<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æƒ³ä½ ç‰† â€” å•ç­”è§£é–ï¼ˆ65 æ­²ï¼‰</title>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --card:#fafafa; --br:#e9e9e9; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto}
    header{padding:16px 20px;font-weight:800;font-size:18px;border-bottom:1px solid var(--br)}
    .wrap{display:flex;flex-direction:column;gap:14px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:680px;margin:0 auto;width:100%}
    button{padding:14px 12px;border:1px solid var(--br);border-radius:12px;background:var(--card);cursor:pointer;font-size:16px;font-weight:700;transition:transform .06s ease, background .2s}
    button:active{transform:scale(.98)}
    .section{max-width:1100px;margin:0 auto;width:100%}
    .canvas-wrap{border:1px dashed var(--br);border-radius:12px;padding:10px;background:#fff}
    #wall{width:100%;height:48vh;display:block}
    .legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;margin:6px 0 0}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--br);border-radius:999px;padding:6px 10px;background:#fff}
    .dot{width:8px;height:8px;border-radius:50%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{border:1px solid var(--br);border-radius:12px;padding:12px;background:#fff}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--br);padding:8px 10px;text-align:right}
    th:first-child, td:first-child{text-align:left}
    .hidden{display:none}
    dialog{border:1px solid var(--br);border-radius:14px;padding:0;max-width:520px}
    dialog header{font-size:16px;padding:12px 14px;border-bottom:1px solid var(--br)}
    dialog .body{padding:14px}
    input[type="text"], textarea, select{width:100%;box-sizing:border-box;border:1px solid var(--br);border-radius:10px;padding:10px;font-size:16px;background:#fff}
    textarea{resize:vertical}
    /* ä¸¦æ’åœ–è¡¨èˆ‡è¡¨æ ¼ */
    .chart-and-table{display:block}
    @media(min-width:900px){.chart-and-table{display:grid;grid-template-columns:1.2fr .8fr;gap:10px}}
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filters label{font-size:14px;color:#444}
  </style>
</head>
<body>
  <!-- è»Ÿç¶¿ç¶¿å–µå–µå«éŸ³æ•ˆï¼šè«‹æŠŠ meow.mp3 æ”¾åœ¨èˆ‡æœ¬æª”ç›¸åŒè³‡æ–™å¤¾ -->
  <audio id="meowSound" src="meow.mp3" preload="auto"></audio>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div>è¨˜åœ¨ç‰†ä¸Šï¼ˆAether & Karenï¼‰</div>
    <button id="btnResetGate" style="font-size:14px;padding:6px 10px">ğŸ”’ é‡æ–°é©—è­‰</button>
  </header>
  <div class="wrap">

    <!-- å•ç­”è§£é–ï¼šæˆ‘å€‘ç´„å®šå¥½å¹¾æ­²ï¼Ÿ -->
    <div id="gate" class="section card">
      <div style="font-weight:800;margin-bottom:6px">æˆ‘å€‘ç´„å®šå¥½å¹¾æ­²ï¼Ÿ</div>
      <div class="row" style="margin-top:8px">
        <input id="answer" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="3" placeholder="è«‹è¼¸å…¥æ•¸å­—ï¼ˆæç¤ºï¼šå…©ä½æ•¸ï¼‰" />
        <button id="btnGate">é–‹å§‹</button>
      </div>
      <div id="gateMsg" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- ä¸»æ“ä½œå€ -->
    <div id="main" class="section hidden">
      <div class="grid">
        <button data-key="think">ğŸ©· æƒ³ä½ </button>
        <button data-key="hug">ğŸ¤— æƒ³æŠ±æŠ±</button>
        <button data-key="kiss">ğŸ˜˜ è¦ªè¦ª</button>
        <button data-key="lean">ğŸ«´ é ä¸€ä¸‹</button>
      </div>

      <div class="canvas-wrap" style="margin-top:8px">
        <canvas id="wall"></canvas>
        <div class="legend">
          <span class="chip"><span class="dot" style="background:#ff6aa2"></span>æƒ³ä½ </span>
          <span class="chip"><span class="dot" style="background:#6aa8ff"></span>æŠ±æŠ±</span>
          <span class="chip"><span class="dot" style="background:#7bd88f"></span>è¦ªè¦ª</span>
          <span class="chip"><span class="dot" style="background:#f7c84b"></span>é ä¸€ä¸‹</span>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="row">
          <button id="btnOpenRedeem">ğŸ å…¨éƒ¨å…Œç¾</button>
          <div class="card" style="flex:1">
            <div class="muted">è·é›¢ä¸Šæ¬¡å…Œç¾å·²éï¼š</div>
            <div id="since" style="font-weight:800;font-size:18px">â€”</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">ç›®å‰ç´¯è¨ˆå·²å…Œç¾ï¼ˆå…¨éƒ¨æœŸé–“ï¼‰</div>
          <div id="totalBox" class="muted">â€”</div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:8px">
            <div style="font-weight:800">å…Œç¾çµ±è¨ˆï¼ˆæŒ‰æ—¥æœŸå½™ç¸½ï¼Œå¯ç¯©é¸ï¼‰</div>
            <div class="filters">
              <label>å¹´åˆ†
                <select id="yearSelect"></select>
              </label>
              <label>æœˆä»½
                <select id="monthSelect">
                  <option value="all">å…¨éƒ¨</option>
                  <option value="1">1 æœˆ</option>
                  <option value="2">2 æœˆ</option>
                  <option value="3">3 æœˆ</option>
                  <option value="4">4 æœˆ</option>
                  <option value="5">5 æœˆ</option>
                  <option value="6">6 æœˆ</option>
                  <option value="7">7 æœˆ</option>
                  <option value="8">8 æœˆ</option>
                  <option value="9">9 æœˆ</option>
                  <option value="10">10 æœˆ</option>
                  <option value="11">11 æœˆ</option>
                  <option value="12">12 æœˆ</option>
                </select>
              </label>
              <div class="muted" id="periodTotal" style="min-width:220px"></div>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>æƒ³ä½ </th>
                <th>æŠ±æŠ±</th>
                <th>è¦ªè¦ª</th>
                <th>é ä¸€ä¸‹</th>
              </tr>
            </thead>
            <tbody id="statsBody"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="font-weight:800;margin-bottom:6px">å…Œç¾å°æ•…äº‹ï¼ˆç„¡é™è¼‰å…¥ï¼‰</div>
          <div id="storiesList" class="muted">å°šç„¡ç´€éŒ„</div>
          <div style="text-align:center;margin-top:8px">
            <button id="btnMoreStories" class="hidden">è¼‰å…¥æ›´å¤šå°æ•…äº‹</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å…¨éƒ¨å…Œç¾å°è©±æ¡†ï¼šé è¦½ç›®å‰æ•¸é‡ + å°æ•…äº‹ -->
  <dialog id="dlgRedeem">
    <header>ç¢ºèªå…¨éƒ¨å…Œç¾</header>
    <div class="body">
      <div id="redeemPreview" class="card" style="margin-bottom:10px"></div>
      <label style="display:block;margin-top:6px">å°æ•…äº‹ï¼ˆé¸å¡«ï¼‰
        <textarea id="rStory" rows="4" placeholder="æƒ³è¨˜ä¸€ä¸‹ä»Šå¤©æ€éº¼å…Œç¾çš„å—ï¼Ÿ"></textarea>
      </label>
      <div class="muted" style="margin-top:8px">æç¤ºï¼šæœ¬æ¬¡å°‡æŠŠç‰†ä¸Šç›®å‰çš„æ‰€æœ‰æ•¸é‡ä¸€æ¬¡å…Œç¾ä¸¦æ­¸é›¶ã€‚</div>
    </div>
    <div class="actions" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--br)">
      <button id="btnCancelRedeem">å–æ¶ˆ</button>
      <button id="btnConfirmRedeem">ç¢ºèªå…Œç¾</button>
    </div>
  </dialog>

  <script type="module">
    // ===== 1) æ›æˆä½ çš„ Firebase è¨­å®š =====
	const firebaseConfig = {
	  apiKey: "AIzaSyAiJTyJGBZIOQW9KAmBUNbxdBFJFr2ABuc",
	  authDomain: "aether-karen-board.firebaseapp.com",
	  projectId: "aether-karen-board",
	  storageBucket: "aether-karen-board.firebasestorage.app",
	  messagingSenderId: "907550532349",
	  appId: "1:907550532349:web:c6bf67c8b86d44e3841494",
	  measurementId: "G-Y91SWR8FBQ"
	};

    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment,
      collection, getDocs, query, orderBy, serverTimestamp, addDoc, limit, startAfter
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ====================== å°å·¥å…·/é€šç”¨å‡½å¼ ======================
    const sinceEl = document.getElementById('since');
    const dlg = document.getElementById('dlgRedeem');
    const btnOpenRedeem = document.getElementById('btnOpenRedeem');
    const btnCancelRedeem = document.getElementById('btnCancelRedeem');
    const btnConfirmRedeem = document.getElementById('btnConfirmRedeem');
    const preview = document.getElementById('redeemPreview');
    const meow = document.getElementById('meowSound');

    // å°è©±æ¡†ç›¸å®¹è™•ç†
    function openModal(){ if (typeof dlg.showModal === 'function') dlg.showModal(); else dlg.setAttribute('open',''); }
    function closeModal(){ if (typeof dlg.close === 'function') dlg.close(); else dlg.removeAttribute('open'); }

    function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }

    // å€’æ•¸è¨ˆæ™‚
    let sinceTimer=null;
    function startSinceTimer(last){
      if (sinceTimer) clearInterval(sinceTimer);
      function render(){
        const now = new Date();
        let s = Math.max(0, Math.floor((now - last)/1000));
        const days = Math.floor(s/86400); s%=86400; const hrs=Math.floor(s/3600); s%=3600; const mins=Math.floor(s/60); const secs=s%60;
        const parts = [];
        if (days>0) parts.push(`${days} å¤©`);
        parts.push(`${String(hrs).padStart(2,'0')}å°æ™‚ ${String(mins).padStart(2,'0')}åˆ† ${String(secs).padStart(2,'0')}ç§’`);
        sinceEl.textContent = parts.join(' ');
      }
      render();
      sinceTimer = setInterval(render,1000);
    }

    // ====================== å•ç­”è§£é–ï¼ˆ65ï¼‰ ======================
    const gate = document.getElementById('gate');
    const main = document.getElementById('main');
    const answerInput = document.getElementById('answer');
    const gateBtn = document.getElementById('btnGate');
    const gateMsg = document.getElementById('gateMsg');

    function openMain(){ gate.classList.add('hidden'); main.classList.remove('hidden'); }

    function normalizeDigits(s){
      // å…¨å½¢æ•¸å­—è½‰åŠå½¢
      return (s||'').replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 48));
    }

    function tryUnlock(){
      const raw = (answerInput.value||'').trim();
      const norm = normalizeDigits(raw);
      const val = parseInt(norm, 10);
      if (Number.isNaN(val)){ gateMsg.textContent = 'è«‹è¼¸å…¥æ•¸å­—'; return; }
      if (val !== 65){ gateMsg.textContent = 'ç­”éŒ¯å›‰ï½å†æƒ³æƒ³ â¤'; return; }
      localStorage.setItem('gate-ok','1');
      openMain();
    }

    gateBtn.addEventListener('click', tryUnlock);
    answerInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') tryUnlock(); });

    if (localStorage.getItem('gate-ok') === '1') openMain();

    // ====================== æ­£å­—ç‰†ï¼ˆFirestore è¨ˆæ•¸ï¼‰ ======================
    const COUNTS_PATH = { col: 'tally-wall', id: 'global' };
    const countsRef = doc(db, COUNTS_PATH.col, COUNTS_PATH.id);
    async function ensureCountsDoc(){
      const snap = await getDoc(countsRef);
      if (!snap.exists()) await setDoc(countsRef, { think:0, hug:0, kiss:0, lean:0, createdAt: Date.now() });
    }

    const canvas = document.getElementById('wall');
    const ctx = canvas.getContext('2d', { alpha: true });
    const COLORS = { think: '#ff6aa2', hug: '#6aa8ff', kiss: '#7bd88f', lean: '#f7c84b' };

    function fitCanvas(){
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      drawAll(lastCounts);
    }
    window.addEventListener('resize', fitCanvas);

    function drawGroup(x, y, color, scale=1){
      const w = 34*scale, h = 28*scale, gap = 6*scale; const top=y, bottom=y+h;
      ctx.strokeStyle = color; ctx.lineWidth = 2;
      for (let i=0;i<4;i++){ const xi = x + i*gap + 2*i; ctx.beginPath(); ctx.moveTo(xi, top); ctx.lineTo(xi, bottom); ctx.stroke(); }
      ctx.beginPath(); ctx.moveTo(x-2, bottom-2); ctx.lineTo(x+gap*3+6, top+2);
      ctx.stroke(); return {w,h};
    }
    function drawTallies(startX,startY,color,count,scale=1,maxPerRow=12){
      let x=startX, y=startY; const groupSize=5, spacingX=40*scale, spacingY=38*scale;
      const groups=Math.floor(count/groupSize), remain=count%groupSize;
      for(let i=0;i<groups;i++){ drawGroup(x,y,color,scale); x+=spacingX; if((i+1)%maxPerRow===0){x=startX; y+=spacingY;} }
      if (remain>0){ const top=y, bottom=y+28*scale; ctx.strokeStyle=color; ctx.lineWidth=2; const gap=6*scale; for(let i=0;i<remain;i++){const xi=x+i*gap+2*i; ctx.beginPath(); ctx.moveTo(xi, top); ctx.lineTo(xi, bottom); ctx.stroke();} }
    }
    function layout(){ const rect=canvas.getBoundingClientRect(); const margin=18; const midX=rect.width/2, midY=rect.height/2; return { think:{x:margin,y:margin}, hug:{x:midX+margin/2,y:margin}, kiss:{x:margin,y:midY+margin/2}, lean:{x:midX+margin/2,y:midY+margin/2} } }

    let lastCounts = { think:0, hug:0, kiss:0, lean:0 };
    function drawAll(c){ if(!canvas.width||!canvas.height) return; const rect=canvas.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height); ctx.fillStyle="#666"; ctx.font="bold 14px system-ui"; const pos=layout(c); ctx.fillText(`æƒ³ä½  (${c.think||0})`, pos.think.x, pos.think.y-6); ctx.fillText(`æƒ³æŠ±æŠ± (${c.hug||0})`, pos.hug.x, pos.hug.y-6); ctx.fillText(`è¦ªè¦ª (${c.kiss||0})`, pos.kiss.x, pos.kiss.y-6); ctx.fillText(`é ä¸€ä¸‹ (${c.lean||0})`, pos.lean.x, pos.lean.y-6); const scale=1; drawTallies(pos.think.x,pos.think.y,COLORS.think,c.think||0,scale); drawTallies(pos.hug.x,pos.hug.y,COLORS.hug,c.hug||0,scale); drawTallies(pos.kiss.x,pos.kiss.y,COLORS.kiss,c.kiss||0,scale); drawTallies(pos.lean.x,pos.lean.y,COLORS.lean,c.lean||0,scale); }

    // ====================== å…Œç¾ï¼ˆå…¨éƒ¨å…Œç¾ + æ­¸é›¶ï¼‰ ======================
    const lastRedeemRef = doc(db,'last-redeem','time');

    btnOpenRedeem.addEventListener('click', async ()=>{
      await ensureCountsDoc();
      const snap = await getDoc(countsRef);
      const c = snap.data() || {think:0,hug:0,kiss:0,lean:0};
      preview.innerHTML = `ç›®å‰å°‡å…Œç¾ï¼šæƒ³ä½  <b>${c.think||0}</b>ã€æŠ±æŠ± <b>${c.hug||0}</b>ã€è¦ªè¦ª <b>${c.kiss||0}</b>ã€é ä¸€ä¸‹ <b>${c.lean||0}</b>`;
      openModal();
    });
    btnCancelRedeem.addEventListener('click', ()=> closeModal());

    btnConfirmRedeem.addEventListener('click', async ()=>{
      const originalText = btnConfirmRedeem.textContent;
      btnConfirmRedeem.disabled = true; btnConfirmRedeem.textContent = 'è™•ç†ä¸­â€¦';
      try{
        await ensureCountsDoc();
        const story = (document.getElementById('rStory').value||'').trim();
        const snap = await getDoc(countsRef);
        const c = snap.data() || {think:0,hug:0,kiss:0,lean:0};
        const sum = (c.think||0)+(c.hug||0)+(c.kiss||0)+(c.lean||0);
        if (sum===0 && !story){ alert('ç›®å‰æ²’æœ‰å¯å…Œç¾çš„æ•¸é‡ï¼Œè«‹å…ˆæŒ‰å¹¾ä¸‹æˆ–å¯«ä¸€æ®µå°æ•…äº‹å–”'); return; }

        const dateId = ymd(new Date());
        await addDoc(collection(db,'redeems'),{ date: dateId, think:c.think||0, hug:c.hug||0, kiss:c.kiss||0, lean:c.lean||0, story, ts: serverTimestamp() });
        await setDoc(countsRef,{ think:0,hug:0,kiss:0,lean:0 },{ merge:true });
        await setDoc(lastRedeemRef,{ ts: serverTimestamp() });

        document.getElementById('rStory').value='';
        closeModal();
        await loadStats();
        await loadStoryPage(true);
      }catch(e){
        console.error(e);
        alert('å…Œç¾å¤±æ•—ï¼š' + (e?.message || e));
      }finally{
        btnConfirmRedeem.disabled = false; btnConfirmRedeem.textContent = originalText;
      }
    });

    // å€’æ•¸ï¼šç›£è½æœ€å¾Œå…Œç¾æ™‚é–“
    onSnapshot(lastRedeemRef,(snap)=>{
      const d = snap.data();
      const ts = d?.ts?.toDate?.();
      if (ts) startSinceTimer(ts);
    });

    // ====================== çµ±è¨ˆï¼ˆä¾æ—¥æœŸå½™ç¸½ + ç„¡é™å°æ•…äº‹ + åœ–è¡¨ï¼‹æœˆä»½/å¹´åˆ†ï¼‰ ======================
    const statsBody = document.getElementById('statsBody');
    const storiesList = document.getElementById('storiesList');
    const totalBox = document.getElementById('totalBox');
    const btnMoreStories = document.getElementById('btnMoreStories');
    const periodTotal = document.getElementById('periodTotal');
    const btnResetGate = document.getElementById('btnResetGate');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    
    let masterEntries = []; // å…¨éƒ¨å…Œç¾ï¼ˆä¾æ—¥æœŸèšåˆå¾Œçš„é™£åˆ—ï¼‰
    let masterTotals = {think:0,hug:0,kiss:0,lean:0};

    function filterBySelection(){
      const year = parseInt(yearSelect.value,10);
      const mval = monthSelect.value; // 'all' æˆ– 1..12
      const filtered = masterEntries.filter(e=>{
        const [y,mm,dd] = e.date.split('-').map(Number);
        if (y !== year) return false;
        if (mval !== 'all' && mm !== parseInt(mval,10)) return false;
        return true;
      });
      // è¡¨æ ¼
      if (filtered.length===0){
        statsBody.innerHTML = '<tr><td colspan="5" class="muted">æ­¤æœŸé–“ç„¡å…Œç¾ç´€éŒ„</td></tr>';
      } else {
        statsBody.innerHTML = filtered.map(v=>`<tr><td>${v.date}</td><td>${v.think}</td><td>${v.hug}</td><td>${v.kiss}</td><td>${v.lean}</td></tr>`).join('');
      }
      // åœ–è¡¨å·²ç§»é™¤
      // æœŸé–“ç´¯è¨ˆ
      const pt = filtered.reduce((acc,v)=>{ acc.think+=v.think||0;acc.hug+=v.hug||0;acc.kiss+=v.kiss||0;acc.lean+=v.lean||0; return acc; },{think:0,hug:0,kiss:0,lean:0});
      periodTotal.textContent = `æœ¬æœŸé–“ç´¯è¨ˆï¼šæƒ³ä½  ${pt.think}ã€æŠ±æŠ± ${pt.hug}ã€è¦ªè¦ª ${pt.kiss}ã€é ä¸€ä¸‹ ${pt.lean}`;
    }

    function populateYearOptions(){
      if (!yearSelect) return;
      const years = Array.from(new Set(masterEntries.map(e=> Number(e.date.slice(0,4))))).sort((a,b)=>a-b);
      yearSelect.innerHTML = years.map(y=>`<option value="${y}">${y} å¹´</option>`).join('');
      const nowY = new Date().getFullYear();
      if (years.includes(nowY)) yearSelect.value = String(nowY); else yearSelect.value = String(years[years.length-1]||nowY);
    }

    async function loadStats(){
      // ç‰†å³æ™‚
      onSnapshot(countsRef,(snap)=>{
        const d=snap.data()||{}; lastCounts = { think:d.think||0, hug:d.hug||0, kiss:d.kiss||0, lean:d.lean||0 }; fitCanvas();
      });

      statsBody.innerHTML = '<tr><td colspan="5" class="muted">è®€å–ä¸­â€¦</td></tr>';
      if (storiesList) storiesList.textContent = 'è®€å–ä¸­â€¦';

      const q = query(collection(db,'redeems'), orderBy('date','asc'));
      const snap = await getDocs(q);
      const byDate = new Map();
      masterTotals = { think:0, hug:0, kiss:0, lean:0 };
      snap.forEach(docSnap=>{
        const d = docSnap.data()||{};
        const key = d.date || 'æœªçŸ¥æ—¥æœŸ';
        const agg = byDate.get(key) || {think:0,hug:0,kiss:0,lean:0};
        agg.think += d.think||0; agg.hug += d.hug||0; agg.kiss += d.kiss||0; agg.lean += d.lean||0;
        byDate.set(key, agg);
        masterTotals.think += d.think||0; masterTotals.hug += d.hug||0; masterTotals.kiss += d.kiss||0; masterTotals.lean += d.lean||0;
      });

      // å…¨æœŸé–“ç´¯è¨ˆé¡¯ç¤º
      if (totalBox){ totalBox.textContent = `æƒ³ä½  ${masterTotals.think}ã€æŠ±æŠ± ${masterTotals.hug}ã€è¦ªè¦ª ${masterTotals.kiss}ã€é ä¸€ä¸‹ ${masterTotals.lean}`; }

      // è½‰æˆæ’åºé™£åˆ—
      masterEntries = Array.from(byDate.entries()).map(([date,v])=>({date,...v}));
      masterEntries.sort((a,b)=> a.date.localeCompare(b.date));

      populateYearOptions();
      filterBySelection();

      // å°æ•…äº‹ï¼šå…ˆè¼‰å…¥ç¬¬ä¸€é 
      await loadStoryPage(true);
    }

    // å¹´/æœˆè®Šæ›´ â†’ é‡æ–°å¥—ç”¨ç¯©é¸
    document.addEventListener('change', (e)=>{
      if (e.target===yearSelect || e.target===monthSelect) filterBySelection();
    });

    // ========= å°æ•…äº‹ç„¡é™è¼‰å…¥ =========
    let storyCursor = null; const STORY_PAGE = 20;
    async function loadStoryPage(reset=false){
      try{
        if (!storiesList || !btnMoreStories) return;
        if (reset){ storiesList.innerHTML = ''; storyCursor = null; btnMoreStories.classList.add('hidden'); }
        let qy = query(collection(db,'redeems'), orderBy('ts','desc'), limit(STORY_PAGE));
        if (storyCursor) qy = query(collection(db,'redeems'), orderBy('ts','desc'), startAfter(storyCursor), limit(STORY_PAGE));
        const snap = await getDocs(qy);
        if (snap.empty){ if (reset) storiesList.textContent = 'å°šç„¡ç´€éŒ„'; return; }
        const docs = snap.docs; storyCursor = docs[docs.length-1];
        const html = docs.map(docSnap=>{
          const d = docSnap.data()||{};
          const dt = d.ts?.toDate?.() || new Date();
          const y = dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const dd=String(dt.getDate()).padStart(2,'0');
          const hh=String(dt.getHours()).padStart(2,'0'); const mm=String(dt.getMinutes()).padStart(2,'0');
          const story = (d.story||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return `<div style="margin:6px 0"><strong>${y}-${m}-${dd} ${hh}:${mm}</strong>ï¼ˆæƒ³ä½ ${d.think||0} æŠ±æŠ±${d.hug||0} è¦ªè¦ª${d.kiss||0} é ä¸€ä¸‹${d.lean||0}ï¼‰<br>${story}</div>`;
        }).join('');
        storiesList.insertAdjacentHTML('beforeend', html);
        if (docs.length === STORY_PAGE) btnMoreStories.classList.remove('hidden');
        else btnMoreStories.classList.add('hidden');
      }catch(err){ storiesList.textContent = 'è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'; console.error(err); }
    }

    if (document.getElementById('btnMoreStories')){
      btnMoreStories.addEventListener('click', ()=> loadStoryPage(false));
    }

    // é‡æ–°é©—è­‰æŒ‰éˆ•ï¼ˆæ¸…é™¤ gate-okï¼‰
    if (btnResetGate){
      btnResetGate.addEventListener('click', ()=>{
        localStorage.removeItem('gate-ok');
        const g = document.getElementById('gate');
        const m = document.getElementById('main');
        if (g && m){ m.classList.add('hidden'); g.classList.remove('hidden'); }
        const msg = document.getElementById('gateMsg');
        if (msg) msg.textContent = 'å·²é‡ç½®ï¼Œè«‹é‡æ–°å›ç­”ï¼šæˆ‘å€‘ç´„å®šå¥½å¹¾æ­²ï¼Ÿ';
        const ans = document.getElementById('answer'); if (ans) ans.value='';
      });
    }

    // æ”¯æ´ç¶²å€åŠ ä¸Š ?reset=1 å¼·åˆ¶é¡¯ç¤ºé©—è­‰
    try{ const u = new URL(window.location.href); if (u.searchParams.get('reset')==='1'){ localStorage.removeItem('gate-ok'); } }catch(_){ }

    // ====================== åˆå§‹åŒ–ï¼ˆå…ˆåŒ¿åç™»å…¥ï¼ŒæˆåŠŸå¾Œå†è¼‰å…¥è³‡æ–™ï¼‰ ======================
    signInAnonymously(auth).catch((e)=>{
      console.error('åŒ¿åç™»å…¥å¤±æ•—', e);
      const m = document.getElementById('gateMsg');
      if (m) m.textContent = 'åŒ¿åç™»å…¥å¤±æ•—ï¼š' + (e?.code || e?.message || 'æœªçŸ¥éŒ¯èª¤');
      alert('åŒ¿åç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ Firebase Authentication æ˜¯å¦å·²å•Ÿç”¨ Anonymousã€‚');
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;
      try{
        await ensureCountsDoc();
        await loadStats();
      }catch(e){ console.error(e); }
    });

    // ====================== æŒ‰éˆ•è¨ˆæ•¸ ======================
    document.querySelectorAll('button[data-key]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        // æ’­æ”¾å–µå–µéŸ³æ•ˆï¼ˆè»Ÿç¶¿ç¶¿ï¼‰
        try{ if (meow){ meow.currentTime = 0; await meow.play(); } }catch(_){ /* æŸäº›ç€è¦½å™¨éœ€ä½¿ç”¨è€…äº’å‹•å¾Œæ‰å¯æ’­æ”¾ï¼Œå¯å¿½ç•¥éŒ¯èª¤ */ }
        try{
          await updateDoc(countsRef, { [btn.dataset.key]: increment(1) });
        }catch(e){
          await ensureCountsDoc();
          await updateDoc(countsRef, { [btn.dataset.key]: increment(1) });
        }
      });
    });

  </script>
</body>
</html>
